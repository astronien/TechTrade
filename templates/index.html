<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Trade-In (Pro Max)</title>
    <link rel="icon"
        href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üìä</text></svg>">

    <!-- UI UX Pro Max Resources -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/modern-ui.css') }}">
    <!-- Custom Font moved to CSS import but preconnect here for speed -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>

    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
</head>

<body>
    <!-- Sidebar -->
    <div class="sidebar">
        <div class="sidebar-logo">üìä Trade-In</div>
        <ul class="sidebar-menu">
            <li><a href="#" class="active" onclick="showPage('search', event); return false;"><span>üîç</span>
                    ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</a></li>
            <li><a href="#" onclick="showPage('report', event); return false;"><span>üìà</span> ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏¢‡∏≠‡∏î‡πÄ‡∏ó‡∏£‡∏î</a></li>
            <li><a href="#" onclick="showPage('zones', event); return false;"><span>üó∫Ô∏è</span> ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ Zone</a></li>
            <li><a href="#" onclick="showPage('autocancel', event); return false;"><span>‚è∞</span> ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</a>
            </li>
            <li><a href="#" onclick="openSettings(); return false;"><span>‚öôÔ∏è</span> ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</a></li>
            <li><a href="#" onclick="showTelegramSetup(); return false;"><span>üì±</span> ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Telegram</a></li>
            <li style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #e0e0e0;">
                <a href="/logout" style="color: #dc3545;"><span>üö™</span> ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</a>
            </li>
        </ul>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Search Page -->
        <div id="searchPage" class="page-section active">
            <div class="container">
                <h1>üîç ‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Trade-In</h1>

                <div
                    style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; background: rgba(255,255,255,0.1); padding: 10px; border-radius: 10px;">
                    <div>
                        <span id="statusText" style="margin-left: 10px; color: #90EE90; font-size: 14px;">ü§ñ Auto-Login
                            ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</span>
                    </div>
                    <div>
                        <button onclick="openSettings()" class="secondary"
                            style="padding: 8px 20px; font-size: 14px;">‚öôÔ∏è
                            ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</button>
                    </div>
                </div>

                <div class="search-panel">
                    <form id="searchForm">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="zoneSelect">üó∫Ô∏è ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Zone (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Area Manager):</label>
                                <select id="zoneSelect" class="form-control" onchange="handleZoneChange()">
                                    <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏µ‡∏•‡∏∞‡∏™‡∏≤‡∏Ç‡∏≤ --</option>
                                </select>
                                <small class="form-text text-muted">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Zone ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏´‡∏•‡∏≤‡∏¢‡∏™‡∏≤‡∏Ç‡∏≤‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡∏±‡∏ô</small>
                            </div>

                            <div class="form-group">
                                <label for="branchSelect">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏≤‡∏Ç‡∏≤:</label>
                                <select id="branchSelect" class="form-control" onchange="handleBranchChange()">
                                    <option value="">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</option>
                                </select>
                                <small id="branchStatus" class="form-text text-muted"></small>
                            </div>

                            <div class="form-group">
                                <label>‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</label>
                                <input type="text" id="saleCode" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô">
                            </div>

                            <div class="form-group">
                                <label>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡πÄ‡∏ó‡∏£‡∏î (‡∏à‡∏≤‡∏Å)</label>
                                <input type="date" id="dateStart" required>
                            </div>

                            <div class="form-group">
                                <label>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡πÄ‡∏ó‡∏£‡∏î (‡∏ñ‡∏∂‡∏á)</label>
                                <input type="date" id="dateEnd" required>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡πÄ‡∏ó‡∏£‡∏î</label>
                                <select id="status">
                                    <option value="">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
                                    <option value="1">‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏£‡∏≤‡∏Ñ‡∏≤</option>
                                    <option value="2">‡∏≠‡∏¢‡∏π‡πà‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ã‡∏∑‡πâ‡∏≠‡πÉ‡∏´‡πâ‡∏£‡∏≤‡∏Ñ‡∏≤</option>
                                    <option value="3">‡∏£‡∏≠‡∏ú‡∏π‡πâ‡∏Ç‡∏≤‡∏¢‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏£‡∏≤‡∏Ñ‡∏≤</option>
                                    <option value="4">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏£‡∏≤‡∏Ñ‡∏≤‡πÅ‡∏•‡πâ‡∏ß</option>
                                    <option value="5">‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏£‡∏≤‡∏Ñ‡∏≤</option>
                                    <option value="6">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</option>
                                    <option value="7">‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏≠‡∏¢‡∏π‡πà‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label>‡πÅ‡∏ö‡∏£‡∏ô‡∏î‡πå</label>
                                <select id="brand" multiple size="1">
                                    <option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
                                    <option value="TRUSCO">TRUSCO</option>
                                    <option value="Acer">Acer</option>
                                    <option value="Apple">Apple</option>
                                    <option value="Asus">Asus</option>
                                    <option value="Avita">Avita</option>
                                    <option value="BOX">BOX</option>
                                    <option value="COM7">COM7</option>
                                    <option value="Dell">Dell</option>
                                    <option value="Fujitsu">Fujitsu</option>
                                    <option value="Garmin">Garmin</option>
                                    <option value="Gigabyte">Gigabyte</option>
                                    <option value="Honor">Honor</option>
                                    <option value="HP">HP</option>
                                    <option value="Huawei">Huawei</option>
                                    <option value="Infinix">Infinix</option>
                                    <option value="Lenovo">Lenovo</option>
                                    <option value="LG">LG</option>
                                    <option value="Microsoft">Microsoft</option>
                                    <option value="MSI">MSI</option>
                                    <option value="Nintendo">Nintendo</option>
                                    <option value="Nothing">Nothing</option>
                                    <option value="OnePlus">OnePlus</option>
                                    <option value="Oppo">Oppo</option>
                                    <option value="Realme">Realme</option>
                                    <option value="Samsung">Samsung</option>
                                    <option value="Sony">Sony</option>
                                    <option value="Vivo">Vivo</option>
                                    <option value="Xiaomi">Xiaomi</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label>‡∏£‡∏∏‡πà‡∏ô</label>
                                <input type="text" id="series" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏∏‡πà‡∏ô">
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label>‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á</label>
                                <select id="docRefType">
                                    <option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
                                    <option value="1">‡∏£‡∏∞‡∏ö‡∏∏</option>
                                    <option value="0">‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label>‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á</label>
                                <input type="text" id="docRefNumber" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£">
                            </div>

                            <div class="form-group">
                                <label>‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î (‡πÅ‡∏ö‡∏£‡∏ô‡∏î‡πå)</label>
                                <input type="text" id="promoCode" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡πÇ‡∏Ñ‡πâ‡∏î‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô">
                            </div>

                            <div class="form-group">
                                <label>‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</label>
                                <select id="customerSign">
                                    <option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
                                    <option value="1">‡πÄ‡∏ã‡πá‡∏ô‡πÅ‡∏•‡πâ‡∏ß</option>
                                    <option value="2">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏ã‡πá‡∏ô</option>
                                </select>
                            </div>
                        </div>

                        <div class="btn-group">
                            <button type="submit">üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</button>
                            <button type="button" class="secondary" onclick="resetForm()">üîÑ ‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡πà‡∏≤</button>
                        </div>
                    </form>
                </div>

                <div class="data-container" id="dataContainer">
                    <p style="text-align: center; color: #999; padding: 50px;">
                        ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡∏∞‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° "‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•
                    </p>
                </div>
            </div>
        </div>
        <!-- End Search Page -->

        <!-- Report Page -->
        <div id="reportPage" class="page-section">
            <div class="container">
                <h1>üìà ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏¢‡∏≠‡∏î‡πÄ‡∏ó‡∏£‡∏î</h1>

                <div class="search-panel">
                    <form id="reportForm">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="reportZoneSelect">üó∫Ô∏è ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Zone (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Area Manager):</label>
                                <select id="reportZoneSelect" class="form-control" onchange="handleReportZoneChange()">
                                    <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏µ‡∏•‡∏∞‡∏™‡∏≤‡∏Ç‡∏≤ --</option>
                                </select>
                                <small class="form-text text-muted">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Zone ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏´‡∏•‡∏≤‡∏¢‡∏™‡∏≤‡∏Ç‡∏≤‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡∏±‡∏ô</small>
                            </div>

                            <div class="form-group">
                                <label for="reportBranchSelect">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏≤‡∏Ç‡∏≤:</label>
                                <select id="reportBranchSelect" class="form-control"
                                    onchange="handleReportBranchChange()">
                                    <option value="">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</option>
                                </select>
                                <small id="reportBranchStatus" class="form-text text-muted"></small>
                            </div>

                            <div class="form-group">
                                <label>‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</label>
                                <input type="text" id="reportSaleCode" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô">
                            </div>

                            <div class="form-group">
                                <label>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô</label>
                                <input type="date" id="reportDateStart" required>
                            </div>

                            <div class="form-group">
                                <label>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î</label>
                                <input type="date" id="reportDateEnd" required>
                            </div>
                        </div>

                        <div class="btn-group">
                            <button type="submit">üìä ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</button>
                            <button type="button" class="secondary" onclick="resetReportForm()">üîÑ ‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡πà‡∏≤</button>
                            <button type="button" class="secondary" onclick="openAnnualReportModal()"
                                style="background: #28a745;">üìä ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô Excel ‡∏£‡∏≤‡∏¢‡∏õ‡∏µ</button>
                        </div>
                    </form>
                </div>

                <div class="data-container" id="reportContainer">
                    <p style="text-align: center; color: #999; padding: 50px;">
                        ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡∏∞‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° "‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•
                    </p>
                </div>
            </div>
        </div>
        <!-- End Report Page -->

        <!-- Zone Management Page -->
        <div id="zonesPage" class="page-section">
            <div class="container">
                <h1>üó∫Ô∏è ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ Zone (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Area Manager)</h1>

                <div class="search-panel">
                    <div
                        style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3 style="margin: 0;">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ Zone ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h3>
                        <button onclick="openAddZoneModal()" style="padding: 10px 20px;">‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏° Zone ‡πÉ‡∏´‡∏°‡πà</button>
                    </div>

                    <div id="zonesList"></div>
                </div>
            </div>
        </div>
        <!-- End Zone Management Page -->

        <!-- Auto-Cancel Page -->
        <div id="autocancelPage" class="page-section">
            <div class="container">
                <h1>‚è∞ ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</h1>

                <div class="search-panel">
                    <!-- Toggle -->
                    <div
                        style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
                        <div>
                            <h3 style="margin:0; color: var(--text-main);">Auto-Cancel</h3>
                            <small style="color: var(--text-muted);">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ "‡∏£‡∏≠‡∏ú‡∏π‡πâ‡∏Ç‡∏≤‡∏¢‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏£‡∏≤‡∏Ñ‡∏≤"
                                ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏ï‡∏≤‡∏°‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡∏±‡πâ‡∏á</small>
                        </div>
                        <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                            <input type="checkbox" id="acEnabled" style="width: 20px; height: 20px; cursor: pointer;">
                            <span id="acStatusText" style="font-weight: 600; color: var(--text-muted);">‡∏õ‡∏¥‡∏î‡∏≠‡∏¢‡∏π‡πà</span>
                        </label>
                    </div>

                    <hr style="border: none; border-top: 1px solid #e2e8f0; margin-bottom: 20px;">

                    <!-- ‡πÄ‡∏ß‡∏•‡∏≤ -->
                    <div class="form-row">
                        <div class="form-group">
                            <label>‚è∞ ‡πÄ‡∏ß‡∏•‡∏≤‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</label>
                            <input type="time" id="acTime" value="23:00" class="form-control">
                        </div>
                    </div>

                    <!-- ‡∏™‡∏≤‡∏Ç‡∏≤ -->
                    <div class="form-group" style="margin-bottom: 20px;">
                        <label>üè™ ‡∏™‡∏≤‡∏Ç‡∏≤ (‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏î‡πâ‡∏´‡∏•‡∏≤‡∏¢‡∏™‡∏≤‡∏Ç‡∏≤)</label>
                        <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                            <select id="acBranchSelect" class="form-control" style="flex: 1;">
                                <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏≤‡∏Ç‡∏≤ --</option>
                            </select>
                            <button onclick="addAutoCancelBranch()"
                                style="padding: 8px 16px; font-size: 13px; white-space: nowrap;">‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°</button>
                        </div>
                        <div id="acSelectedBranches" style="display: flex; flex-wrap: wrap; gap: 8px;"></div>
                    </div>

                    <hr style="border: none; border-top: 1px solid #e2e8f0; margin-bottom: 20px;">

                    <!-- ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô -->
                    <h3 style="color: var(--primary); margin-bottom: 15px;">üë§ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label>‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</label>
                            <input type="text" id="acEmpCode" placeholder="‡πÄ‡∏ä‡πà‡∏ô 12345" class="form-control">
                        </div>
                        <div class="form-group">
                            <label>‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</label>
                            <input type="text" id="acEmpName" placeholder="‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•" class="form-control">
                        </div>
                        <div class="form-group">
                            <label>‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£</label>
                            <input type="text" id="acEmpPhone" placeholder="‡πÄ‡∏ä‡πà‡∏ô 081-234-5678" class="form-control">
                        </div>
                    </div>

                    <!-- ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó/‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏ -->
                    <div class="form-row">
                        <div class="form-group">
                            <label>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏≤‡∏£‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</label>
                            <select id="acCancelType" class="form-control">
                                <option value="1">‡πÇ‡∏î‡∏ô‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏à‡∏≤‡∏Å‡∏ú‡∏π‡πâ‡∏Ç‡∏≤‡∏¢</option>
                                <option value="2">‡∏≠‡∏∑‡πà‡∏ô‡πÜ</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</label>
                            <select id="acReasonCancel" class="form-control">
                                <option value="1">‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÉ‡∏à‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÑ‡∏ß‡πâ‡πÉ‡∏ä‡πâ‡πÄ‡∏≠‡∏á</option>
                                <option value="2">‡∏£‡∏≤‡∏Ñ‡∏≤‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£</option>
                                <option value="3">‡∏≠‡∏∑‡πà‡∏ô‡πÜ</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group" style="margin-bottom: 20px;">
                        <label>‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°</label>
                        <input type="text" id="acDescription" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏• (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)" class="form-control">
                    </div>

                    <hr style="border: none; border-top: 1px solid #e2e8f0; margin-bottom: 20px;">

                    <!-- Telegram -->
                    <h3 style="color: #0088cc; margin-bottom: 15px;">üì± ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô Telegram</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Bot Token</label>
                            <input type="text" id="acTelegramToken" placeholder="Bot Token" class="form-control">
                        </div>
                        <div class="form-group">
                            <label>Chat ID</label>
                            <input type="text" id="acTelegramChatId" placeholder="Chat ID" class="form-control">
                        </div>
                    </div>

                    <!-- ‡∏õ‡∏∏‡πà‡∏° -->
                    <div style="display: flex; gap: 15px; margin-top: 25px;">
                        <button onclick="saveAutoCancelConfig()" style="padding: 12px 30px;">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                        <button onclick="testAutoCancel()" class="secondary"
                            style="padding: 12px 30px; background: #f59e0b; color: white; border: none;">üß™
                            ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏£‡∏±‡∏ô‡πÄ‡∏î‡∏µ‡πã‡∏¢‡∏ß‡∏ô‡∏µ‡πâ</button>
                    </div>
                </div>

                <!-- Log -->
                <div class="data-container">
                    <div
                        style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h3 style="margin: 0;">üìã ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ô</h3>
                        <button onclick="loadAutoCancelLogs()" class="secondary"
                            style="padding: 8px 16px; font-size: 13px;">üîÑ ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä</button>
                    </div>
                    <div id="acLogsContainer">‡∏Å‡∏î‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</div>
                </div>
            </div>
        </div>
        <!-- End Auto-Cancel Page -->
    </div>

    <!-- Modal ‡πÄ‡∏û‡∏¥‡πà‡∏°/‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç Zone -->
    <div id="zoneModal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <span class="close" onclick="closeZoneModal()">&times;</span>
                <span id="zoneModalTitle">‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏° Zone ‡πÉ‡∏´‡∏°‡πà</span>
            </div>
            <div class="modal-body">
                <input type="hidden" id="editingZoneId">

                <div class="form-group" style="margin-bottom: 15px;">
                    <label>‡∏ä‡∏∑‡πà‡∏≠ Zone</label>
                    <input type="text" id="zoneName" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û - ‡πÉ‡∏à‡∏Å‡∏•‡∏≤‡∏á‡πÄ‡∏°‡∏∑‡∏≠‡∏á">
                </div>

                <div class="form-group" style="margin-bottom: 15px;">
                    <label>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏≤‡∏Ç‡∏≤‡πÉ‡∏ô Zone</label>
                    <div
                        style="border: 1px solid #ddd; border-radius: 8px; padding: 15px; max-height: 400px; overflow-y: auto; background: #f9f9f9;">
                        <div style="margin-bottom: 10px;">
                            <input type="text" id="branchSearchInput" placeholder="üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏™‡∏≤‡∏Ç‡∏≤..."
                                style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 5px;"
                                onkeyup="filterBranchList()">
                        </div>
                        <div style="margin-bottom: 10px;">
                            <button onclick="selectAllBranches()" class="secondary"
                                style="padding: 6px 12px; font-size: 13px; margin-right: 5px;">‚úÖ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
                            <button onclick="deselectAllBranches()" class="secondary"
                                style="padding: 6px 12px; font-size: 13px;">‚ùå ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
                        </div>
                        <div id="branchCheckboxList"
                            style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 8px;">
                            <!-- ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏î‡πâ‡∏ß‡∏¢ JavaScript -->
                        </div>
                    </div>
                    <small class="form-text text-muted">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏≤‡∏Ç‡∏≤‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô Zone ‡∏ô‡∏µ‡πâ (‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏î‡πâ‡∏´‡∏•‡∏≤‡∏¢‡∏™‡∏≤‡∏Ç‡∏≤)</small>
                </div>
            </div>
            <div class="modal-footer">
                <button onclick="closeZoneModal()" class="secondary">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                <button onclick="saveZone()">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Zone</button>
            </div>
        </div>
    </div>

    <!-- Modal ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô Excel ‡∏£‡∏≤‡∏¢‡∏õ‡∏µ -->
    <div id="annualReportModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <span class="close" onclick="closeAnnualReportModal()">&times;</span>
                üìä ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô Excel ‡∏£‡∏≤‡∏¢‡∏õ‡∏µ
            </div>
            <div class="modal-body">
                <div class="form-group" style="margin-bottom: 15px;">
                    <label>‡∏õ‡∏µ (‡∏Ñ.‡∏®. ‡∏´‡∏£‡∏∑‡∏≠ ‡∏û.‡∏®.)</label>
                    <input type="number" id="annualReportYear" placeholder="‡πÄ‡∏ä‡πà‡∏ô 2024 ‡∏´‡∏£‡∏∑‡∏≠ 2567" min="2020" max="2568">
                    <small class="form-text text-muted">‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏ó‡∏±‡πâ‡∏á ‡∏Ñ.‡∏®. (2024) ‡πÅ‡∏•‡∏∞ ‡∏û.‡∏®. (2567)</small>
                </div>
                <div class="form-group" style="margin-bottom: 15px;">
                    <label>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</label>
                    <select id="annualReportMonth"
                        style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                        <option value="">‡∏ó‡∏±‡πâ‡∏á‡∏õ‡∏µ (All Year)</option>
                        <option value="1">‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏° (January)</option>
                        <option value="2">‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå (February)</option>
                        <option value="3">‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏° (March)</option>
                        <option value="4">‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô (April)</option>
                        <option value="5">‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏° (May)</option>
                        <option value="6">‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô (June)</option>
                        <option value="7">‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏° (July)</option>
                        <option value="8">‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏° (August)</option>
                        <option value="9">‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô (September)</option>
                        <option value="10">‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏° (October)</option>
                        <option value="11">‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô (November)</option>
                        <option value="12">‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏° (December)</option>
                    </select>
                </div>
                <div class="form-group" style="margin-bottom: 15px;">
                    <label>üó∫Ô∏è ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Zone (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Area Manager)</label>
                    <select id="annualReportZone" class="form-control" onchange="handleAnnualReportZoneChange()">
                        <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏µ‡∏•‡∏∞‡∏™‡∏≤‡∏Ç‡∏≤ --</option>
                    </select>
                    <small class="form-text text-muted">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Zone ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏´‡∏•‡∏≤‡∏¢‡∏™‡∏≤‡∏Ç‡∏≤‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡∏±‡∏ô</small>
                </div>
                <div class="form-group" style="margin-bottom: 15px;">
                    <label>‡∏™‡∏≤‡∏Ç‡∏≤ (‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö)</label>
                    <select id="annualReportBranch" class="form-control">
                        <option value="">-- ‡∏ó‡∏∏‡∏Å‡∏™‡∏≤‡∏Ç‡∏≤ --</option>
                    </select>
                    <small class="form-text text-muted">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏≤‡∏Ç‡∏≤‡πÄ‡∏â‡∏û‡∏≤‡∏∞ ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏ß‡πâ‡∏ô‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏ó‡∏∏‡∏Å‡∏™‡∏≤‡∏Ç‡∏≤</small>
                </div>
                <p style="color: #666; font-size: 14px; margin-top: 20px;">
                    üí° <strong>‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏à‡∏∞‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡∏î‡πâ‡∏ß‡∏¢:</strong><br>
                    ‚Ä¢ ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÅ‡∏™‡∏î‡∏á‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏ó‡∏£‡∏î‡πÅ‡∏ï‡πà‡∏•‡∏∞‡πÄ‡∏î‡∏∑‡∏≠‡∏ô (‡∏°‡∏Ñ.-‡∏ò‡∏Ñ.)<br>
                    ‚Ä¢ ‡∏Å‡∏£‡∏≤‡∏ü‡πÅ‡∏ó‡πà‡∏á (Bar Chart) ‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô<br>
                    ‚Ä¢ ‡πÑ‡∏ü‡∏•‡πå Excel (.xlsx) ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î<br><br>
                    ‚ö†Ô∏è <strong>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏:</strong><br>
                    ‚Ä¢ <strong>‡∏™‡∏≤‡∏Ç‡∏≤‡πÄ‡∏î‡∏µ‡∏¢‡∏ß:</strong> ‡πÅ‡∏™‡∏î‡∏á‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö + Export Excel (‡πÄ‡∏£‡πá‡∏ß 5-10 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ)<br>
                    ‚Ä¢ <strong>Zone:</strong> Export Excel ‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á (‡πÉ‡∏ä‡πâ‡πÄ‡∏ß‡∏•‡∏≤ 2-5 ‡∏ô‡∏≤‡∏ó‡∏µ)
                </p>
            </div>
            <div class="modal-footer">
                <button onclick="closeAnnualReportModal()" class="secondary">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                <button onclick="generateAnnualReport()">üìä ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</button>
            </div>
        </div>
    </div>

    <!-- Modal ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô -->
    <div id="settingsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <span class="close" onclick="closeSettings()">&times;</span>
                ‚öôÔ∏è ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô
            </div>
            <div class="modal-body">
                <style>
                    .settings-grid {
                        display: grid;
                        grid-template-columns: 1fr;
                        gap: 20px;
                    }

                    @media (min-width: 768px) {
                        .settings-grid {
                            grid-template-columns: 1fr 1fr;
                        }
                    }

                    .settings-section {
                        background: #f8f9fa;
                        padding: 15px;
                        border-radius: 8px;
                        border: 1px solid #e9ecef;
                    }

                    .settings-section h3 {
                        margin-top: 0;
                        font-size: 1.1em;
                        margin-bottom: 15px;
                        border-bottom: 2px solid #ddd;
                        padding-bottom: 10px;
                    }

                    .full-width {
                        grid-column: 1 / -1;
                    }
                </style>

                <div class="settings-grid">
                    <!-- Column 1: Personal Info -->
                    <div class="settings-section">
                        <h3 style="color: #4a5568;">üë§ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</h3>
                        <div class="form-group" style="margin-bottom: 15px;">
                            <label>‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</label>
                            <input type="text" id="settingEmpCode" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô" class="form-control">
                        </div>
                        <div class="form-group" style="margin-bottom: 15px;">
                            <label>‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</label>
                            <input type="text" id="settingEmpName" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô" class="form-control">
                        </div>
                        <div class="form-group" style="margin-bottom: 15px;">
                            <label>‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå</label>
                            <input type="text" id="settingEmpPhone" placeholder="‡πÄ‡∏ä‡πà‡∏ô 081-234-5678"
                                class="form-control">
                        </div>
                    </div>

                    <!-- Column 2: Cancellation Settings -->
                    <div class="settings-section">
                        <h3 style="color: #e53e3e;">‚ùå ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Å‡∏≤‡∏£‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</h3>
                        <div class="form-group" style="margin-bottom: 15px;">
                            <label>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏≤‡∏£‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</label>
                            <select id="settingCancelType" class="form-control">
                                <option value="1">‡πÇ‡∏î‡∏ô‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏à‡∏≤‡∏Å‡∏ú‡∏π‡πâ‡∏Ç‡∏≤‡∏¢</option>
                                <option value="2">‡∏≠‡∏∑‡πà‡∏ô‡πÜ</option>
                            </select>
                        </div>
                        <div class="form-group" style="margin-bottom: 15px;">
                            <label>‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</label>
                            <select id="settingReasonCancel" class="form-control">
                                <option value="1">‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÉ‡∏à‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÑ‡∏ß‡πâ‡πÉ‡∏ä‡πâ‡πÄ‡∏≠‡∏á</option>
                                <option value="2">‡∏£‡∏≤‡∏Ñ‡∏≤‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£</option>
                                <option value="3">‡∏≠‡∏∑‡πà‡∏ô‡πÜ</option>
                            </select>
                        </div>
                    </div>

                    <!-- Update Branches (Full Width) -->
                    <div class="settings-section full-width" style="border-color: #bee3f8; background-color: #ebf8ff;">
                        <h3 style="color: #3182ce; border-color: #90cdf4;">üîÑ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≤‡∏Ç‡∏≤</h3>
                        <div
                            style="display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 10px;">
                            <p style="font-size: 14px; color: #666; margin: 0; max-width: 60%;">
                                ‡∏´‡∏≤‡∏Å‡∏°‡∏µ‡∏™‡∏≤‡∏Ç‡∏≤‡πÉ‡∏´‡∏°‡πà (‡πÄ‡∏ä‡πà‡∏ô 2919) ‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÅ‡∏™‡∏î‡∏á‡πÉ‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ ‡πÉ‡∏´‡πâ‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡∏ô‡∏µ‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö
                            </p>
                            <button onclick="autoUpdateBranches()"
                                style="padding: 10px 20px; background-color: #3182ce; color: white; border: none; border-radius: 5px; cursor: pointer;">
                                üîÑ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏Ç‡∏≤
                            </button>
                        </div>
                        <small id="updateBranchResult" class="form-text text-muted"
                            style="display: block; margin-top: 5px; text-align: right;"></small>
                    </div>

                    <!-- Session Cookie section ‡∏ñ‡∏π‡∏Å‡∏•‡∏ö‡∏≠‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß - ‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏ä‡πâ Auto-Login -->

                    <!-- Column 2: Eve Credentials -->
                    <div class="settings-section">
                        <h3 style="color: #dd6b20;">ü§ñ Eve Credentials (Bot)</h3>
                        <div class="form-group" style="margin-bottom: 10px;">
                            <input type="text" id="settingEveUser" placeholder="Eve Username" class="form-control"
                                style="font-size: 13px;">
                        </div>
                        <div class="form-group" style="margin-bottom: 10px;">
                            <div style="display: flex; gap: 5px;">
                                <input type="password" id="settingEvePass" placeholder="Eve Password"
                                    class="form-control" style="flex: 1; font-size: 13px;">
                                <button onclick="togglePasswordVisibility('settingEvePass')"
                                    style="padding: 5px; width: 30px;">üëÅÔ∏è</button>
                            </div>
                        </div>
                        <div <div
                            style="margin-top: 10px; display: flex; align-items: center; justify-content: space-between;">
                            <button onclick="runBotUpdate()"
                                style="background-color: #dd6b20; color: white; border: none; padding: 5px 15px; border-radius: 4px; cursor: pointer; font-size: 13px; width: 100%;">
                                ü§ñ Run Bot Now
                            </button>
                        </div>
                        <div style="text-align: center; margin-top: 5px;">
                            <span id="botStatus" style="font-size: 11px; color: #666;">(‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏£‡∏∞‡∏ö‡∏ö Active Update)</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button onclick="closeSettings()" class="secondary">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                <button onclick="saveSettings()">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
            </div>
        </div>
    </div>

    <script src="{{ url_for('static', filename='branches-data.js') }}"></script>
    <script src="{{ url_for('static', filename='zones-data.js') }}"></script>
    <script>
        // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
        window.addEventListener('load', () => {
            const today = new Date();
            const yesterday = new Date(today);
            yesterday.setDate(yesterday.getDate() - 1);

            document.getElementById('dateStart').valueAsDate = yesterday;
            document.getElementById('dateEnd').valueAsDate = today;
            document.getElementById('reportDateStart').valueAsDate = yesterday;
            document.getElementById('reportDateEnd').valueAsDate = today;

            // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏à‡∏≤‡∏Å localStorage
            loadEmployeeSettings();

            // ‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏ä‡πâ Auto-Login ‚Äî ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Session ID

            // ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏≤‡∏Ç‡∏≤
            loadBranches();

            // ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ Zones
            loadZones();
        });

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÇ‡∏´‡∏•‡∏î‡∏Ñ‡πà‡∏≤‡∏™‡∏≤‡∏Ç‡∏≤‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ß‡πâ‡∏à‡∏≤‡∏Å localStorage
        function loadSavedBranch() {
            return localStorage.getItem('selected_branch_id') || '231';
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≤‡∏Ç‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
        function saveBranchSelection() {
            const branchSelect = document.getElementById('branchSelect');
            const reportBranchSelect = document.getElementById('reportBranchSelect');

            if (branchSelect && branchSelect.value) {
                const selectedOption = branchSelect.options[branchSelect.selectedIndex];
                const branchId = branchSelect.value;
                const branchName = selectedOption ? selectedOption.textContent : branchId;

                localStorage.setItem('selected_branch_id', branchId);
                localStorage.setItem('selected_branch_name', branchName);

                console.log(`üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≤‡∏Ç‡∏≤: ${branchId} - ${branchName}`);
            }

            // Sync ‡∏Å‡∏±‡∏ö report dropdown
            if (reportBranchSelect && branchSelect) {
                reportBranchSelect.value = branchSelect.value;
            }
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏≤‡∏Ç‡∏≤‡πÉ‡∏ô dropdown
        function populateBranchDropdown(branches) {
            const branchSelect = document.getElementById('branchSelect');
            const reportBranchSelect = document.getElementById('reportBranchSelect');
            const branchStatus = document.getElementById('branchStatus');
            const reportBranchStatus = document.getElementById('reportBranchStatus');

            // Clear options ‡πÄ‡∏î‡∏¥‡∏°
            branchSelect.innerHTML = '';
            reportBranchSelect.innerHTML = '';

            // ‡∏™‡∏£‡πâ‡∏≤‡∏á option elements ‡∏à‡∏≤‡∏Å branches array
            branches.forEach(branch => {
                const option1 = document.createElement('option');
                const option2 = document.createElement('option');

                // ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏≠‡∏≤‡∏à‡πÅ‡∏ï‡∏Å‡∏ï‡πà‡∏≤‡∏á‡∏Å‡∏±‡∏ô
                const branchId = branch.BRANCH_ID || branch.branch_id || branch.id || branch.value;
                const branchName = branch.BRANCH_NAME || branch.branch_name || branch.name || branch.text || branchId;

                option1.value = branchId;
                option1.textContent = `${branchId} - ${branchName}`;
                option2.value = branchId;
                option2.textContent = `${branchId} - ${branchName}`;

                branchSelect.appendChild(option1);
                reportBranchSelect.appendChild(option2);
            });

            // ‡πÅ‡∏™‡∏î‡∏á‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏≤‡∏Ç‡∏≤‡∏ó‡∏µ‡πà‡∏û‡∏ö
            branchStatus.textContent = `‚úÖ ‡∏û‡∏ö ${branches.length} ‡∏™‡∏≤‡∏Ç‡∏≤`;
            branchStatus.className = 'form-text text-success';
            reportBranchStatus.textContent = `‚úÖ ‡∏û‡∏ö ${branches.length} ‡∏™‡∏≤‡∏Ç‡∏≤`;
            reportBranchStatus.className = 'form-text text-success';

            // ‡πÇ‡∏´‡∏•‡∏î‡∏Ñ‡πà‡∏≤‡∏™‡∏≤‡∏Ç‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ß‡πâ‡∏à‡∏≤‡∏Å localStorage
            const savedBranchId = loadSavedBranch();

            // Set selected option ‡∏ï‡∏≤‡∏°‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡πÇ‡∏´‡∏•‡∏î
            branchSelect.value = savedBranchId;
            reportBranchSelect.value = savedBranchId;

            // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÉ‡∏ô dropdown ‡πÉ‡∏´‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏±‡∏ß‡πÅ‡∏£‡∏Å
            if (!branchSelect.value && branches.length > 0) {
                const firstBranchId = branches[0].BRANCH_ID || branches[0].branch_id || branches[0].id || branches[0].value;
                branchSelect.value = firstBranchId;
                reportBranchSelect.value = firstBranchId;
            }

            console.log(`‚úÖ ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏≤‡∏Ç‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${branches.length} ‡∏™‡∏≤‡∏Ç‡∏≤, ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å: ${branchSelect.value}`);
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏î‡∏∂‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏≤‡∏Ç‡∏≤
        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏î‡∏∂‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏≤‡∏Ç‡∏≤ (‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Hardcode ‡∏à‡∏≤‡∏Å branches-data.js)
        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏î‡∏∂‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏≤‡∏Ç‡∏≤ (API)
        async function loadBranches() {
            const branchSelect = document.getElementById('branchSelect');
            const reportBranchSelect = document.getElementById('reportBranchSelect');
            const branchStatus = document.getElementById('branchStatus');
            const reportBranchStatus = document.getElementById('reportBranchStatus');

            branchStatus.textContent = '‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...';
            reportBranchStatus.textContent = '‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...';

            try {
                // 1. ‡∏•‡∏≠‡∏á‡∏î‡∏∂‡∏á‡∏à‡∏≤‡∏Å API (Database)
                const response = await fetch('/api/branches');
                const result = await response.json();

                if (result.success && result.branches && result.branches.length > 0) {
                    console.log(`‚úÖ Loaded ${result.branches.length} branches from ${result.source}`);
                    populateBranchDropdown(result.branches);
                    return;
                }
            } catch (error) {
                console.warn('‚ö†Ô∏è API load failed, trying fallback:', error);
            }

            // 2. Fallback: ‡∏ñ‡πâ‡∏≤ API ‡∏û‡∏±‡∏á ‡πÉ‡∏´‡πâ‡∏•‡∏≠‡∏á‡πÉ‡∏ä‡πâ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ global (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
            if (typeof BRANCHES_DATA !== 'undefined' && BRANCHES_DATA && BRANCHES_DATA.length > 0) {
                console.log('‚ö†Ô∏è Using static BRANCHES_DATA fallback');
                populateBranchDropdown(BRANCHES_DATA);

                // Passive Update: ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏≤‡∏à‡∏à‡∏∞‡πÄ‡∏Å‡πà‡∏≤ ‡∏•‡∏≠‡∏á trigger update ‡πÅ‡∏ö‡∏ö‡πÄ‡∏á‡∏µ‡∏¢‡∏ö‡πÜ
                autoUpdateBranches(true);
            } else {
                console.error('‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≤‡∏Ç‡∏≤‡πÄ‡∏•‡∏¢');
                // Try passive update even if everything failed, maybe we have a session
                await autoUpdateBranches(true);

                // Check again
                const retryResponse = await fetch('/api/branches');
                const retryResult = await retryResponse.json();
                if (retryResult.success && retryResult.branches && retryResult.branches.length > 0) {
                    populateBranchDropdown(retryResult.branches);
                    return;
                }

                branchStatus.textContent = '‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≤‡∏Ç‡∏≤ (‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á Login ‡πÉ‡∏´‡∏°‡πà)';
                branchStatus.className = 'form-text text-danger';
                reportBranchStatus.textContent = '‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≤‡∏Ç‡∏≤';
                reportBranchStatus.className = 'form-text text-danger';
            }
        }


        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÇ‡∏´‡∏•‡∏î Zone dropdown
        async function loadZones() {
            const zoneSelect = document.getElementById('zoneSelect');
            const reportZoneSelect = document.getElementById('reportZoneSelect');

            // ‡∏•‡πâ‡∏≤‡∏á options ‡πÄ‡∏î‡∏¥‡∏° (‡πÄ‡∏ß‡πâ‡∏ô option ‡πÅ‡∏£‡∏Å)
            while (zoneSelect.options.length > 1) {
                zoneSelect.remove(1);
            }
            while (reportZoneSelect.options.length > 1) {
                reportZoneSelect.remove(1);
            }

            // ‡πÇ‡∏´‡∏•‡∏î zones ‡∏à‡∏≤‡∏Å server (‡∏£‡∏ß‡∏° custom zones)
            const zones = await loadZonesFromStorage();

            if (!zones || zones.length === 0) {
                console.warn('‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Zones');
                return;
            }

            // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó ZONES_DATA ‡πÉ‡∏ô memory
            if (typeof ZONES_DATA !== 'undefined') {
                ZONES_DATA.length = 0;
                ZONES_DATA.push(...zones);
            }

            // ‡πÄ‡∏û‡∏¥‡πà‡∏° options
            console.log('üîç Zones data received:', zones);
            zones.forEach(zone => {
                // ‡πÅ‡∏õ‡∏•‡∏á branch_ids ‡πÄ‡∏õ‡πá‡∏ô array ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô string
                let branchIds = zone.branch_ids;
                if (typeof branchIds === 'string') {
                    try {
                        branchIds = JSON.parse(branchIds);
                    } catch (e) {
                        console.error('Error parsing branch_ids:', e);
                        branchIds = [];
                    }
                }
                zone.branch_ids = branchIds || [];

                const branchCount = Array.isArray(zone.branch_ids) ? zone.branch_ids.length : 0;

                const option1 = document.createElement('option');
                option1.value = zone.zone_id;
                option1.textContent = `${zone.zone_name} (${branchCount} ‡∏™‡∏≤‡∏Ç‡∏≤)`;
                zoneSelect.appendChild(option1);

                const option2 = document.createElement('option');
                option2.value = zone.zone_id;
                option2.textContent = `${zone.zone_name} (${branchCount} ‡∏™‡∏≤‡∏Ç‡∏≤)`;
                reportZoneSelect.appendChild(option2);

                console.log(`   ‚úì Added zone: ${zone.zone_id} - ${zone.zone_name} (${branchCount} branches)`);
            });

            console.log(`‚úÖ ‡πÇ‡∏´‡∏•‡∏î ${zones.length} Zones (‡∏£‡∏ß‡∏° custom zones)`);
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Zone (Search Page)
        function handleZoneChange() {
            const zoneSelect = document.getElementById('zoneSelect');
            const branchSelect = document.getElementById('branchSelect');
            const selectedZone = zoneSelect.value;

            if (!selectedZone) {
                // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Zone ‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏≤‡∏Ç‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                populateBranchDropdown(BRANCHES_DATA);
                branchSelect.disabled = false;
                return;
            }

            // ‡∏î‡∏∂‡∏á‡∏™‡∏≤‡∏Ç‡∏≤‡πÉ‡∏ô Zone ‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
            const branches = ZoneHelper.getBranchesByZone(selectedZone);
            populateBranchDropdown(branches);

            // ‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏≤‡∏Ç‡∏≤ (‡∏à‡∏∞‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ó‡∏±‡πâ‡∏á Zone)
            branchSelect.value = '';
            branchSelect.disabled = true;

            const zone = ZONES_DATA.find(z => z.zone_id === selectedZone);
            document.getElementById('branchStatus').textContent =
                `üó∫Ô∏è ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Zone: ${zone.zone_name} (${branches.length} ‡∏™‡∏≤‡∏Ç‡∏≤)`;
            document.getElementById('branchStatus').className = 'form-text text-success';

            console.log(`üó∫Ô∏è ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Zone: ${selectedZone}, ‡∏™‡∏≤‡∏Ç‡∏≤: ${branches.length}`);
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏≤‡∏Ç‡∏≤ (Search Page)
        function handleBranchChange() {
            const zoneSelect = document.getElementById('zoneSelect');
            const branchSelect = document.getElementById('branchSelect');

            if (branchSelect.value) {
                // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏≤‡∏Ç‡∏≤ ‡πÉ‡∏´‡πâ‡∏•‡πâ‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Zone
                zoneSelect.value = '';
            }
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Zone (Report Page)
        function handleReportZoneChange() {
            const zoneSelect = document.getElementById('reportZoneSelect');
            const branchSelect = document.getElementById('reportBranchSelect');
            const selectedZone = zoneSelect.value;

            if (!selectedZone) {
                populateBranchDropdown(BRANCHES_DATA);
                branchSelect.disabled = false;
                return;
            }

            const branches = ZoneHelper.getBranchesByZone(selectedZone);
            populateBranchDropdown(branches);

            branchSelect.value = '';
            branchSelect.disabled = true;

            const zone = ZONES_DATA.find(z => z.zone_id === selectedZone);
            document.getElementById('reportBranchStatus').textContent =
                `üó∫Ô∏è ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Zone: ${zone.zone_name} (${branches.length} ‡∏™‡∏≤‡∏Ç‡∏≤)`;
            document.getElementById('reportBranchStatus').className = 'form-text text-success';
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏≤‡∏Ç‡∏≤ (Report Page)
        function handleReportBranchChange() {
            const zoneSelect = document.getElementById('reportZoneSelect');
            const branchSelect = document.getElementById('reportBranchSelect');

            if (branchSelect.value) {
                zoneSelect.value = '';
            }
        }



        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏≤‡∏Ç‡∏≤ (Hybrid)
        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏≤‡∏Ç‡∏≤ (Hybrid)
        async function autoUpdateBranches(silent = false) {
            const resultElem = document.getElementById('updateBranchResult');

            if (!silent && !confirm('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏î‡∏∂‡∏á‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏Ç‡∏≤‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?\n(‡∏≠‡∏≤‡∏à‡πÉ‡∏ä‡πâ‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà)')) {
                return;
            }

            if (!silent) {
                resultElem.textContent = '‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠ Server...';
                resultElem.className = 'form-text text-info';
            }

            try {
                const response = await fetch('/api/admin/update-branches', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({})
                });

                const result = await response.json();

                if (result.success) {
                    console.log(`‚úÖ Branch update successful: ${result.count} branches`);
                    if (!silent) {
                        resultElem.textContent = `‚úÖ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! (${result.count} ‡∏™‡∏≤‡∏Ç‡∏≤)`;
                        resultElem.className = 'form-text text-success';
                        alert(`‚úÖ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≤‡∏Ç‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢ (${result.count} ‡∏™‡∏≤‡∏Ç‡∏≤)`);
                        // Reload branches via API call
                        loadBranches();
                    } else {
                        // Silent update success -> reload dropdown
                        populateBranchDropdown(await (await fetch('/api/branches')).json().then(r => r.branches));
                    }
                } else {
                    if (!silent) {
                        resultElem.textContent = `‚ùå ${result.error}`;
                        resultElem.className = 'form-text text-danger';
                    }
                    console.warn('Branch update failed:', result.error);
                }
            } catch (error) {
                console.error('Error updating branches:', error);
                if (!silent) {
                    resultElem.textContent = `‚ùå Error: ${error.message}`;
                    resultElem.className = 'form-text text-danger';
                }
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            const branchSelect = document.getElementById('branchSelect');
            const reportBranchSelect = document.getElementById('reportBranchSelect');

            if (branchSelect) {
                branchSelect.addEventListener('change', (e) => {
                    // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å saveBranchSelection() ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á
                    saveBranchSelection();

                    // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Trade-In ‡∏î‡πâ‡∏ß‡∏¢ BRANCH_ID ‡πÉ‡∏´‡∏°‡πà (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏™‡∏î‡∏á‡∏≠‡∏¢‡∏π‡πà)
                    const dataContainer = document.getElementById('dataContainer');
                    if (dataContainer && dataContainer.querySelector('.data-table')) {
                        // ‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏™‡∏î‡∏á‡∏≠‡∏¢‡∏π‡πà ‡πÉ‡∏´‡πâ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÉ‡∏´‡∏°‡πà
                        console.log('üîÑ ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏î‡πâ‡∏ß‡∏¢‡∏™‡∏≤‡∏Ç‡∏≤‡πÉ‡∏´‡∏°‡πà:', e.target.value);
                        searchData();
                    }
                });
            }

            if (reportBranchSelect) {
                reportBranchSelect.addEventListener('change', (e) => {
                    // Sync ‡∏Å‡∏±‡∏ö search dropdown
                    if (branchSelect) {
                        branchSelect.value = e.target.value;
                    }
                    saveBranchSelection();

                    // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏™‡∏î‡∏á‡∏≠‡∏¢‡∏π‡πà
                    const reportContainer = document.getElementById('reportContainer');
                    if (reportContainer && reportContainer.querySelector('.data-table')) {
                        console.log('üîÑ ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏î‡πâ‡∏ß‡∏¢‡∏™‡∏≤‡∏Ç‡∏≤‡πÉ‡∏´‡∏°‡πà:', e.target.value);
                        generateReport();
                    }
                });
            }
        });

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤
        function showPage(pageName, event) {
            // ‡∏ã‡πà‡∏≠‡∏ô‡∏ó‡∏∏‡∏Å‡∏´‡∏ô‡πâ‡∏≤
            document.querySelectorAll('.page-section').forEach(section => {
                section.classList.remove('active');
            });

            // ‡πÅ‡∏™‡∏î‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
            if (pageName === 'search') {
                document.getElementById('searchPage').classList.add('active');
            } else if (pageName === 'report') {
                document.getElementById('reportPage').classList.add('active');
            } else if (pageName === 'zones') {
                document.getElementById('zonesPage').classList.add('active');
                loadZonesManagement();
            } else if (pageName === 'autocancel') {
                document.getElementById('autocancelPage').classList.add('active');
                loadAutoCancelConfig();
            }

            // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡πÄ‡∏°‡∏ô‡∏π active
            document.querySelectorAll('.sidebar-menu a').forEach(link => {
                link.classList.remove('active');
            });
            if (event) {
                event.target.closest('a').classList.add('active');
            }
        }

        // ==================== Zone Management Functions ====================

        // ‡πÇ‡∏´‡∏•‡∏î Zones ‡∏à‡∏≤‡∏Å Backend (Server)
        async function loadZonesFromStorage() {
            try {
                const response = await fetch('/api/zones');
                const result = await response.json();

                if (result.success && result.zones) {
                    console.log(`‚úÖ ‡πÇ‡∏´‡∏•‡∏î ${result.zones.length} zones ‡∏à‡∏≤‡∏Å server`);
                    return result.zones;
                }
            } catch (error) {
                console.error('‚ùå Error loading zones from server:', error);
            }

            // ‡∏ñ‡πâ‡∏≤‡πÇ‡∏´‡∏•‡∏î‡∏à‡∏≤‡∏Å server ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ ‡πÉ‡∏ä‡πâ‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏à‡∏≤‡∏Å zones-data.js
            return typeof ZONES_DATA !== 'undefined' ? [...ZONES_DATA] : [];
        }

        // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Zones (‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó memory ‡πÅ‡∏•‡∏∞ dropdown)
        async function saveZonesToStorage(zones) {
            // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó ZONES_DATA ‡πÉ‡∏ô memory
            if (typeof ZONES_DATA !== 'undefined') {
                ZONES_DATA.length = 0;
                ZONES_DATA.push(...zones);
            }
            // ‡∏£‡∏µ‡πÇ‡∏´‡∏•‡∏î Zone dropdowns
            await loadZones();
        }

        // ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ Zones
        async function loadZonesManagement() {
            const zones = await loadZonesFromStorage();
            const container = document.getElementById('zonesList');

            if (zones.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #999; padding: 50px;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ Zone<br>‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° "‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏° Zone ‡πÉ‡∏´‡∏°‡πà" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô</p>';
                return;
            }

            let html = '<div style="display: grid; gap: 15px;">';

            zones.forEach((zone, index) => {
                const branchNames = zone.branch_ids.map(id => {
                    const branch = BRANCHES_DATA.find(b => b.branch_id == id);
                    return branch ? branch.branch_name.split(' : ')[0] : id;
                }).join(', ');

                html += `
                    <div style="background: white; border: 2px solid #e0e0e0; border-radius: 10px; padding: 20px;">
                        <div style="display: flex; justify-content: space-between; align-items: start;">
                            <div style="flex: 1;">
                                <h3 style="margin: 0 0 10px 0; color: #667eea;">üó∫Ô∏è ${zone.zone_name}</h3>
                                <p style="margin: 0 0 5px 0; color: #666;">
                                    <strong>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏≤‡∏Ç‡∏≤:</strong> ${zone.branch_ids.length} ‡∏™‡∏≤‡∏Ç‡∏≤
                                </p>
                                <p style="margin: 0; color: #999; font-size: 13px;">
                                    ${branchNames.substring(0, 100)}${branchNames.length > 100 ? '...' : ''}
                                </p>
                            </div>
                            <div style="display: flex; gap: 10px;">
                                <button onclick="handleEditZone('${zone.zone_id}')" class="secondary" 
                                        style="padding: 8px 16px; font-size: 14px;">‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
                                <button onclick="handleDeleteZone('${zone.zone_id}')" class="danger" 
                                        style="padding: 8px 16px; font-size: 14px; background: #dc3545;">üóëÔ∏è ‡∏•‡∏ö</button>
                            </div>
                        </div>
                    </div>
                `;
            });

            html += '</div>';
            container.innerHTML = html;
        }

        // ‡πÄ‡∏õ‡∏¥‡∏î Modal ‡πÄ‡∏û‡∏¥‡πà‡∏° Zone
        function openAddZoneModal() {
            document.getElementById('zoneModalTitle').textContent = '‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏° Zone ‡πÉ‡∏´‡∏°‡πà';
            document.getElementById('editingZoneId').value = '';
            document.getElementById('zoneName').value = '';

            // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ checkbox ‡∏™‡∏≤‡∏Ç‡∏≤
            createBranchCheckboxList([]);

            document.getElementById('zoneModal').classList.add('show');
        }

        // Wrapper ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö editZone (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏Å‡∏±‡∏ö onclick ‡πÑ‡∏î‡πâ)
        function handleEditZone(zoneId) {
            editZone(zoneId);
        }

        // ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç Zone
        async function editZone(zoneId) {
            const zones = await loadZonesFromStorage();
            const zone = zones.find(z => z.zone_id === zoneId);

            if (!zone) {
                alert('‡πÑ‡∏°‡πà‡∏û‡∏ö Zone ‡∏ô‡∏µ‡πâ');
                return;
            }

            document.getElementById('zoneModalTitle').textContent = '‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç Zone';
            document.getElementById('editingZoneId').value = zoneId;
            document.getElementById('zoneName').value = zone.zone_name;

            // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ checkbox ‡∏™‡∏≤‡∏Ç‡∏≤ ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏≤‡∏Ç‡∏≤‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà
            createBranchCheckboxList(zone.branch_ids);

            document.getElementById('zoneModal').classList.add('show');
        }

        // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ checkbox ‡∏™‡∏≤‡∏Ç‡∏≤
        function createBranchCheckboxList(selectedBranchIds) {
            const container = document.getElementById('branchCheckboxList');

            if (typeof BRANCHES_DATA === 'undefined' || !BRANCHES_DATA) {
                container.innerHTML = '<p style="color: #999;">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≤‡∏Ç‡∏≤</p>';
                return;
            }

            let html = '';
            BRANCHES_DATA.forEach(branch => {
                const isChecked = selectedBranchIds.includes(branch.branch_id);
                html += `
                    <label style="display: flex; align-items: center; padding: 8px; background: white; border: 1px solid #e0e0e0; border-radius: 5px; cursor: pointer; font-size: 13px;" 
                           class="branch-checkbox-item">
                        <input type="checkbox" value="${branch.branch_id}" ${isChecked ? 'checked' : ''} 
                               style="margin-right: 8px; width: 16px; height: 16px;">
                        <span>${branch.branch_name}</span>
                    </label>
                `;
            });

            container.innerHTML = html;
        }

        // ‡∏Å‡∏£‡∏≠‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏≤‡∏Ç‡∏≤
        function filterBranchList() {
            const searchText = document.getElementById('branchSearchInput').value.toLowerCase();
            const items = document.querySelectorAll('.branch-checkbox-item');

            items.forEach(item => {
                const text = item.textContent.toLowerCase();
                if (text.includes(searchText)) {
                    item.style.display = 'flex';
                } else {
                    item.style.display = 'none';
                }
            });
        }

        // ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏≤‡∏Ç‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
        function selectAllBranches() {
            const checkboxes = document.querySelectorAll('#branchCheckboxList input[type="checkbox"]');
            const visibleCheckboxes = Array.from(checkboxes).filter(cb =>
                cb.closest('.branch-checkbox-item').style.display !== 'none'
            );
            visibleCheckboxes.forEach(cb => cb.checked = true);
        }

        // ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
        function deselectAllBranches() {
            const checkboxes = document.querySelectorAll('#branchCheckboxList input[type="checkbox"]');
            const visibleCheckboxes = Array.from(checkboxes).filter(cb =>
                cb.closest('.branch-checkbox-item').style.display !== 'none'
            );
            visibleCheckboxes.forEach(cb => cb.checked = false);
        }

        // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Zone
        async function saveZone() {
            const editingZoneId = document.getElementById('editingZoneId').value;
            const zoneName = document.getElementById('zoneName').value.trim();

            if (!zoneName) {
                alert('‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠ Zone');
                return;
            }

            // ‡∏î‡∏∂‡∏á‡∏™‡∏≤‡∏Ç‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
            const checkboxes = document.querySelectorAll('#branchCheckboxList input[type="checkbox"]:checked');
            const branchIds = Array.from(checkboxes).map(cb => parseInt(cb.value));

            if (branchIds.length === 0) {
                alert('‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏≤‡∏Ç‡∏≤‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏™‡∏≤‡∏Ç‡∏≤');
                return;
            }

            const zones = await loadZonesFromStorage();

            if (editingZoneId) {
                // ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç Zone ‡πÄ‡∏î‡∏¥‡∏°
                const index = zones.findIndex(z => z.zone_id === editingZoneId);
                if (index !== -1) {
                    zones[index].zone_name = zoneName;
                    zones[index].branch_ids = branchIds;
                }
            } else {
                // ‡πÄ‡∏û‡∏¥‡πà‡∏° Zone ‡πÉ‡∏´‡∏°‡πà
                const newZoneId = 'ZONE_CUSTOM_' + Date.now();
                zones.push({
                    zone_id: newZoneId,
                    zone_name: zoneName,
                    branch_ids: branchIds
                });
            }

            // Sync ‡πÑ‡∏õ‡∏¢‡∏±‡∏á Backend (‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á memory)
            await syncZonesToBackend(zones);

            // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó local memory
            await saveZonesToStorage(zones);

            closeZoneModal();
            await loadZonesManagement();

            alert('‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Zone ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
        }

        // Sync Zones ‡πÑ‡∏õ‡∏¢‡∏±‡∏á Backend
        async function syncZonesToBackend(zones) {
            try {
                const response = await fetch('/api/zones', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ zones: zones })
                });

                const result = await response.json();

                if (result.success) {
                    console.log('‚úÖ Sync zones to backend:', result.message);
                } else {
                    console.error('‚ùå Failed to sync zones:', result);
                }
            } catch (error) {
                console.error('‚ùå Error syncing zones:', error);
            }
        }

        // Wrapper ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö deleteZone (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏Å‡∏±‡∏ö onclick ‡πÑ‡∏î‡πâ)
        function handleDeleteZone(zoneId) {
            deleteZone(zoneId);
        }

        // ‡∏•‡∏ö Zone
        async function deleteZone(zoneId) {
            if (!confirm('‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö Zone ‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) {
                return;
            }

            const zones = await loadZonesFromStorage();
            const filtered = zones.filter(z => z.zone_id !== zoneId);

            // Sync ‡πÑ‡∏õ‡∏¢‡∏±‡∏á Backend (‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á memory)
            await syncZonesToBackend(filtered);

            // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó local memory
            await saveZonesToStorage(filtered);

            await loadZonesManagement();

            alert('‚úÖ ‡∏•‡∏ö Zone ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
        }

        // ‡∏õ‡∏¥‡∏î Modal
        function closeZoneModal() {
            document.getElementById('zoneModal').classList.remove('show');
        }

        // ‡πÇ‡∏´‡∏•‡∏î Zones ‡∏à‡∏≤‡∏Å localStorage ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
        // ‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏•‡∏∞ sync zones ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
        window.addEventListener('load', async () => {
            // ‡πÇ‡∏´‡∏•‡∏î custom zones ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ
            // ‡πÇ‡∏´‡∏•‡∏î zones ‡∏à‡∏≤‡∏Å Backend (Server)
            const zones = await loadZonesFromStorage();
            if (zones.length > 0 && typeof ZONES_DATA !== 'undefined') {
                ZONES_DATA.length = 0;
                ZONES_DATA.push(...zones);
                console.log(`‚úÖ ‡πÇ‡∏´‡∏•‡∏î ${zones.length} zones ‡∏à‡∏≤‡∏Å server ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô`);
            }
        });

        // ==================== End Zone Management Functions ====================

        // ==================== Auto-Cancel Functions ====================
        let acSelectedBranchIds = [];

        document.getElementById('acEnabled').addEventListener('change', function () {
            document.getElementById('acStatusText').textContent = this.checked ? '‚úÖ ‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô' : '‡∏õ‡∏¥‡∏î‡∏≠‡∏¢‡∏π‡πà';
            document.getElementById('acStatusText').style.color = this.checked ? '#16a34a' : 'var(--text-muted)';
        });

        async function populateAutoCancelBranches() {
            const select = document.getElementById('acBranchSelect');
            // ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡πÇ‡∏´‡∏•‡∏î‡∏ã‡πâ‡∏≥
            if (select.options.length > 1) return;

            try {
                const response = await fetch('/api/branches');
                const result = await response.json();
                if (result.success && result.branches && result.branches.length > 0) {
                    result.branches.forEach(b => {
                        const option = document.createElement('option');
                        option.value = b.branch_id;
                        option.textContent = `${b.branch_id} - ${b.branch_name || ''}`;
                        select.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Error loading branches for auto-cancel:', error);
            }
        }

        function addAutoCancelBranch() {
            const select = document.getElementById('acBranchSelect');
            const branchId = select.value;
            if (!branchId) return;
            if (acSelectedBranchIds.includes(branchId)) {
                alert('‡∏™‡∏≤‡∏Ç‡∏≤‡∏ô‡∏µ‡πâ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏•‡πâ‡∏ß');
                return;
            }

            acSelectedBranchIds.push(branchId);
            const branchName = select.options[select.selectedIndex].textContent;
            renderSelectedBranches();
            select.value = '';
        }

        function removeAutoCancelBranch(branchId) {
            acSelectedBranchIds = acSelectedBranchIds.filter(id => id !== branchId);
            renderSelectedBranches();
        }

        function renderSelectedBranches() {
            const container = document.getElementById('acSelectedBranches');
            if (acSelectedBranchIds.length === 0) {
                container.innerHTML = '<span style="color: var(--text-muted); font-size: 14px;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏≤‡∏Ç‡∏≤</span>';
                return;
            }

            container.innerHTML = acSelectedBranchIds.map(id => {
                // ‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏Ç‡∏≤
                let name = id;
                const select = document.getElementById('acBranchSelect');
                for (let opt of select.options) {
                    if (opt.value === id) {
                        name = opt.textContent;
                        break;
                    }
                }
                return `<span style="background: var(--primary-light); color: var(--primary); 
                    padding: 6px 12px; border-radius: 20px; font-size: 13px; font-weight: 500;
                    display: inline-flex; align-items: center; gap: 6px;">
                    ${name}
                    <span onclick="removeAutoCancelBranch('${id}')" 
                        style="cursor: pointer; font-size: 16px; line-height: 1;">&times;</span>
                </span>`;
            }).join('');
        }

        async function loadAutoCancelConfig() {
            try {
                await populateAutoCancelBranches();
                const response = await fetch('/api/admin/auto-cancel-config');
                const result = await response.json();

                if (result.success && result.config) {
                    const c = result.config;
                    document.getElementById('acEnabled').checked = c.enabled;
                    document.getElementById('acEnabled').dispatchEvent(new Event('change'));

                    // Format time to HH:mm
                    let timeVal = c.schedule_time || '23:00';
                    if (timeVal.length > 5) timeVal = timeVal.substring(0, 5);
                    document.getElementById('acTime').value = timeVal;
                    document.getElementById('acEmpCode').value = c.emp_code || '';
                    document.getElementById('acEmpName').value = c.emp_name || '';
                    document.getElementById('acEmpPhone').value = c.emp_phone || '';
                    document.getElementById('acCancelType').value = c.cancel_type || '1';
                    document.getElementById('acReasonCancel').value = c.reason_cancel || '1';
                    document.getElementById('acDescription').value = c.description || '';
                    document.getElementById('acTelegramToken').value = c.telegram_bot_token || '';
                    document.getElementById('acTelegramChatId').value = c.telegram_chat_id || '';

                    // ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏≤‡∏Ç‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ß‡πâ
                    if (c.branch_ids) {
                        acSelectedBranchIds = c.branch_ids.split(',').map(s => s.trim()).filter(s => s);
                    } else {
                        acSelectedBranchIds = [];
                    }
                    renderSelectedBranches();
                }
                loadAutoCancelLogs();
            } catch (error) {
                console.error('Error loading auto-cancel config:', error);
            }
        }

        async function saveAutoCancelConfig() {
            const config = {
                enabled: document.getElementById('acEnabled').checked,
                schedule_time: document.getElementById('acTime').value,
                branch_ids: acSelectedBranchIds.join(','),
                emp_code: document.getElementById('acEmpCode').value,
                emp_name: document.getElementById('acEmpName').value,
                emp_phone: document.getElementById('acEmpPhone').value,
                cancel_type: document.getElementById('acCancelType').value,
                reason_cancel: document.getElementById('acReasonCancel').value,
                description: document.getElementById('acDescription').value || '-',
                telegram_bot_token: document.getElementById('acTelegramToken').value,
                telegram_chat_id: document.getElementById('acTelegramChatId').value
            };

            if (config.enabled && !config.branch_ids) {
                alert('‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏≤‡∏Ç‡∏≤‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏™‡∏≤‡∏Ç‡∏≤');
                return;
            }
            if (config.enabled && (!config.emp_code || !config.emp_name || !config.emp_phone)) {
                alert('‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö');
                return;
            }

            try {
                const response = await fetch('/api/admin/auto-cancel-config', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(config)
                });
                const result = await response.json();
                if (result.success) {
                    alert(`‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!\n\n‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ ${config.enabled ? '‡πÄ‡∏ß‡∏•‡∏≤ ' + config.schedule_time + ' ‡∏ô. ‡∏ó‡∏∏‡∏Å‡∏ß‡∏±‡∏ô' : '(‡∏õ‡∏¥‡∏î‡∏≠‡∏¢‡∏π‡πà)'}`);
                } else {
                    alert('‚ùå ' + (result.error || '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à'));
                }
            } catch (error) {
                alert('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message);
            }
        }

        async function testAutoCancel() {
            if (!confirm('üß™ ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏£‡∏±‡∏ô Auto-Cancel ‡πÄ‡∏î‡∏µ‡πã‡∏¢‡∏ß‡∏ô‡∏µ‡πâ?\n\n‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏à‡∏£‡∏¥‡∏á ‡∏ï‡∏≤‡∏°‡∏™‡∏≤‡∏Ç‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡∏±‡πâ‡∏á‡πÑ‡∏ß‡πâ\n‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å config ‡∏Å‡πà‡∏≠‡∏ô‡∏Å‡∏î‡∏ó‡∏î‡∏™‡∏≠‡∏ö')) return;

            try {
                const btn = event.target;
                btn.disabled = true;
                btn.textContent = '‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏£‡∏±‡∏ô...';

                const response = await fetch('/api/admin/auto-cancel-test', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                const result = await response.json();

                btn.disabled = false;
                btn.textContent = 'üß™ ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏£‡∏±‡∏ô‡πÄ‡∏î‡∏µ‡πã‡∏¢‡∏ß‡∏ô‡∏µ‡πâ';

                if (result.success) {
                    const r = result.result || {};
                    alert(`‚úÖ ‡∏£‡∏±‡∏ô Auto-Cancel ‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß!\n\nüîç ‡∏û‡∏ö: ${r.total_found || 0} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£\n‚úÖ ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${r.total_cancelled || 0}\n‚è≠Ô∏è ‡∏Ç‡πâ‡∏≤‡∏°: ${r.total_skipped || 0}\n‚ùå ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ${r.total_failed || 0}\n\n‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÉ‡∏ô Telegram ‡πÅ‡∏•‡∏∞ Log`);
                    loadAutoCancelLogs();
                } else {
                    alert('‚ùå ' + (result.error || '‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à'));
                }
            } catch (error) {
                alert('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message);
            }
        }

        async function loadAutoCancelLogs() {
            const container = document.getElementById('acLogsContainer');
            container.innerHTML = '‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...';

            try {
                const response = await fetch('/api/admin/auto-cancel-logs');
                const result = await response.json();

                if (result.success && result.logs && result.logs.length > 0) {
                    let html = '<table class="data-table"><thead><tr>';
                    html += '<th>‡πÄ‡∏ß‡∏•‡∏≤</th><th>‡∏™‡∏≤‡∏Ç‡∏≤</th><th>‡∏û‡∏ö</th><th>‚úÖ ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</th><th>‚è≠Ô∏è ‡∏Ç‡πâ‡∏≤‡∏°</th><th>‚ùå ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß</th><th>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</th><th>Telegram</th>';
                    html += '</tr></thead><tbody>';

                    result.logs.forEach(log => {
                        const runDate = new Date(log.run_at);
                        const dateStr = runDate.toLocaleString('th-TH', { dateStyle: 'short', timeStyle: 'short' });
                        // Truncate details if too long
                        let details = log.details || '-';
                        if (details.length > 50) {
                            details = `<span title="${details.replace(/"/g, '&quot;')}">${details.substring(0, 50)}...</span>`;
                        }

                        html += `<tr>
                            <td>${dateStr}</td>
                            <td>${log.branch_ids}</td>
                            <td>${log.total_found}</td>
                            <td style="color: #16a34a; font-weight: 600;">${log.total_cancelled}</td>
                            <td>${log.total_skipped}</td>
                            <td style="color: ${log.total_failed > 0 ? '#dc2626' : 'inherit'};">${log.total_failed}</td>
                            <td style="font-size: 12px; color: #666;">${details}</td>
                            <td>${log.telegram_sent ? '‚úÖ' : '‚ùå'}</td>
                        </tr>`;
                    });

                    html += '</tbody></table>';
                    container.innerHTML = html;
                } else {
                    container.innerHTML = '<p style="color: var(--text-muted); text-align: center; padding: 20px;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ô</p>';
                }
            } catch (error) {
                container.innerHTML = '<p style="color: #dc2626;">‚ùå ‡πÇ‡∏´‡∏•‡∏î‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</p>';
            }
        }
        // ==================== End Auto-Cancel Functions ====================

        // checkExtensionAndSession() ‡πÅ‡∏•‡∏∞ dismissBanner() ‡∏ñ‡∏π‡∏Å‡∏•‡∏ö‡∏≠‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß ‚Äî ‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏ä‡πâ Auto-Login

        async function openSettings() {
            document.getElementById('settingsModal').classList.add('show');

            // ‡πÇ‡∏´‡∏•‡∏î‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏à‡∏≤‡∏Å Server
            try {
                const response = await fetch('/api/admin/system-settings');
                const result = await response.json();
                if (result.success) {
                    if (result.eve_username) {
                        document.getElementById('settingEveUser').value = result.eve_username;
                    }
                    if (result.eve_password_set) {
                        // ‡πÅ‡∏™‡∏î‡∏á‡πÉ‡∏´‡πâ‡∏£‡∏π‡πâ‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß
                        document.getElementById('settingEvePass').setAttribute('placeholder', '****** (‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÑ‡∏ß‡πâ‡πÅ‡∏•‡πâ‡∏ß)');
                    }
                }
            } catch (error) {
                console.error('‚ùå Error loading settings:', error);
            }
        }

        function closeSettings() {
            document.getElementById('settingsModal').classList.remove('show');
        }

        function togglePasswordVisibility(id) {
            const input = document.getElementById(id);
            if (input.type === 'password') {
                input.type = 'text';
            } else {
                input.type = 'password';
            }
        }

        async function saveSettings() {
            const empCode = document.getElementById('settingEmpCode').value;
            const empName = document.getElementById('settingEmpName').value;
            const empPhone = document.getElementById('settingEmpPhone').value;
            const cancelType = document.getElementById('settingCancelType').value;
            const reasonCancel = document.getElementById('settingReasonCancel').value;
            const eveUser = document.getElementById('settingEveUser').value;
            const evePass = document.getElementById('settingEvePass').value;

            if (!empCode || !empName || !empPhone) {
                alert('‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô');
                return;
            }

            // ‡∏™‡πà‡∏á‡∏Ñ‡πà‡∏≤ Eve Credentials ‡πÑ‡∏õ‡∏¢‡∏±‡∏á Server (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏≠‡∏Å)
            if (eveUser || evePass) {
                try {
                    const response = await fetch('/api/admin/system-settings', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            eve_username: eveUser,
                            eve_password: evePass
                        })
                    });
                    const result = await response.json();
                    if (!result.success) {
                        console.error('‚ùå Error saving system settings:', result.error);
                        alert(`‚ùå ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ${result.error}`);
                        return;
                    }
                } catch (error) {
                    console.error('‚ùå Error saving system settings:', error);
                }
            }

            // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á localStorage
            localStorage.setItem('empCode', empCode);
            localStorage.setItem('empName', empName);
            localStorage.setItem('empPhone', empPhone);
            localStorage.setItem('cancelType', cancelType);
            localStorage.setItem('reasonCancel', reasonCancel);

            alert('‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
            closeSettings();
        }

        function loadEmployeeSettings() {
            const empCode = localStorage.getItem('empCode') || '';
            const empName = localStorage.getItem('empName') || '';
            const empPhone = localStorage.getItem('empPhone') || '';
            const cancelType = localStorage.getItem('cancelType') || '1';
            const reasonCancel = localStorage.getItem('reasonCancel') || '1';

            document.getElementById('settingEmpCode').value = empCode;
            document.getElementById('settingEmpName').value = empName;
            document.getElementById('settingEmpPhone').value = empPhone;
            document.getElementById('settingCancelType').value = cancelType;
            document.getElementById('settingReasonCancel').value = reasonCancel;
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô Excel ‡∏£‡∏≤‡∏¢‡∏õ‡∏µ
        function openAnnualReportModal() {
            // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏õ‡∏µ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏õ‡∏µ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
            const currentYear = new Date().getFullYear();
            document.getElementById('annualReportYear').value = currentYear;
            document.getElementById('annualReportMonth').value = ''; // Clear month selection

            // ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ Zone
            const zoneSelect = document.getElementById('annualReportZone');
            zoneSelect.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏µ‡∏•‡∏∞‡∏™‡∏≤‡∏Ç‡∏≤ --</option>';

            ZONES_DATA.forEach(zone => {
                const option = document.createElement('option');
                option.value = zone.zone_id;
                option.textContent = zone.zone_name;
                zoneSelect.appendChild(option);
            });

            // ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏≤‡∏Ç‡∏≤‡∏•‡∏á dropdown
            const branchSelect = document.getElementById('annualReportBranch');
            branchSelect.innerHTML = '<option value="">-- ‡∏ó‡∏∏‡∏Å‡∏™‡∏≤‡∏Ç‡∏≤ --</option>';

            BRANCHES_DATA.forEach(branch => {
                const option = document.createElement('option');
                option.value = branch.branch_id;
                option.textContent = branch.branch_name;
                branchSelect.appendChild(option);
            });

            document.getElementById('annualReportModal').classList.add('show');
        }

        function handleAnnualReportZoneChange() {
            const zoneSelect = document.getElementById('annualReportZone');
            const branchSelect = document.getElementById('annualReportBranch');
            const selectedZone = zoneSelect.value;

            if (selectedZone) {
                // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Zone ‡πÉ‡∏´‡πâ disable branch select
                branchSelect.disabled = true;
                branchSelect.value = '';
            } else {
                // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Zone ‡πÉ‡∏´‡πâ enable branch select
                branchSelect.disabled = false;
            }
        }

        function closeAnnualReportModal() {
            document.getElementById('annualReportModal').classList.remove('show');
        }

        // Helper Function: ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏¢‡∏õ‡∏µ‡∏Ç‡∏≠‡∏á 1 ‡∏™‡∏≤‡∏Ç‡∏≤ (‡πÇ‡∏î‡∏¢‡πÅ‡∏ö‡πà‡∏á‡∏î‡∏∂‡∏á‡∏ó‡∏µ‡∏•‡∏∞‡πÄ‡∏î‡∏∑‡∏≠‡∏ô)
        // Helper Function: ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏¢‡∏õ‡∏µ‡∏Ç‡∏≠‡∏á 1 ‡∏™‡∏≤‡∏Ç‡∏≤ (Parallel Fetching)
        // ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πá‡∏ß: ‡πÅ‡∏ö‡πà‡∏á‡∏î‡∏∂‡∏á‡∏ó‡∏µ‡∏•‡∏∞ 4 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡∏±‡∏ô (Batch Size = 4)
        async function fetchAnnualBranchData(year, branchId, onProgress) {
            const monthNames = ['JAN', 'FEB', 'MAR', 'APR', 'MAY', 'JUN',
                'JUL', 'AUG', 'SEP', 'OCT', 'NOV', 'DEC'];
            // ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏° Array ‡∏ß‡πà‡∏≤‡∏á‡πÑ‡∏ß‡πâ 12 ‡∏ä‡πà‡∏≠‡∏á (index 0-11)
            const monthlyData = new Array(12).fill(null);

            let totalRecords = 0;
            let totalAgreed = 0;

            // Function ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏î‡∏∂‡∏á 1 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô
            const fetchMonth = async (m) => {
                const params = new URLSearchParams({
                    year: year,
                    month: m,
                    branchId: branchId || ''
                });

                try {
                    const response = await fetch(`/api/annual-report-data?${params.toString()}`);
                    const result = await response.json();

                    if (!response.ok) {
                        console.error(`Error fetching month ${m}:`, result.error);
                        return { month: monthNames[m - 1], month_number: m, count: 0, agreed: 0, not_agreed: 0 };
                    }

                    if (result.success && result.daily_data) {
                        let mCount = 0;
                        let mAgreed = 0;
                        result.daily_data.forEach(d => {
                            mCount += (d.count || 0);
                            mAgreed += (d.agreed || 0);
                        });
                        return {
                            month: monthNames[m - 1],
                            month_number: m,
                            count: mCount,
                            agreed: mAgreed,
                            not_agreed: mCount - mAgreed
                        };
                    }
                } catch (e) {
                    console.error(`Exception fetching month ${m}:`, e);
                }
                return { month: monthNames[m - 1], month_number: m, count: 0, agreed: 0, not_agreed: 0 };
            };

            // ‡πÅ‡∏ö‡πà‡∏á‡∏ó‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡∏ä‡∏∏‡∏î ‡∏ä‡∏∏‡∏î‡∏•‡∏∞ 2 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô (Reduced Load for Stability)
            const batches = [
                [1, 2],
                [3, 4],
                [5, 6],
                [7, 8],
                [9, 10],
                [11, 12]
            ];

            for (let i = 0; i < batches.length; i++) {
                const batch = batches[i];

                // Update UI ‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏° Batch
                if (onProgress) {
                    // ‡πÇ‡∏ä‡∏ß‡πå‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡πÅ‡∏£‡∏Å‡∏Ç‡∏≠‡∏á Batch
                    onProgress(batch[0], 12, `${monthNames[batch[0] - 1]} - ${monthNames[batch[batch.length - 1] - 1]}`);
                }

                // ‡∏£‡∏±‡∏ô‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡∏±‡∏ô 3 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô
                const results = await Promise.all(batch.map(m => fetchMonth(m)));

                // ‡πÄ‡∏Å‡πá‡∏ö‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏•‡∏á Array
                results.forEach((res, idx) => {
                    const monthIndex = batch[idx] - 1; // 0-based index
                    monthlyData[monthIndex] = res;
                    totalRecords += res.count;
                    totalAgreed += res.agreed;
                });

                // ‡∏û‡∏±‡∏Å‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á Batch (safe rate limit: 4000ms)
                if (i < batches.length - 1) {
                    await new Promise(r => setTimeout(r, 4000));
                }
            }

            // ‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏Ç‡∏≤ (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
            let branchName = 'Unknown Branch';
            if (branchId) {
                const branch = BRANCHES_DATA.find(b => b.branch_id == branchId || b.branch_id == String(branchId));
                if (branch) branchName = branch.branch_name;
                else branchName = `‡∏™‡∏≤‡∏Ç‡∏≤ ${branchId}`;
            } else {
                branchName = '‡∏ó‡∏∏‡∏Å‡∏™‡∏≤‡∏Ç‡∏≤';
            }

            return {
                branch_id: branchId,
                branch_name: branchName,
                total_records: totalRecords,
                total_agreed: totalAgreed,
                total_not_agreed: totalRecords - totalAgreed,
                monthly_data: monthlyData
            };
        }

        async function generateAnnualReport() {
            const yearInput = document.getElementById('annualReportYear').value;
            const month = document.getElementById('annualReportMonth').value;
            const zoneId = document.getElementById('annualReportZone').value;
            const branchId = document.getElementById('annualReportBranch').value;

            if (!yearInput) { alert('‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏õ‡∏µ'); return; }

            let year = parseInt(yearInput);
            if (year > 2500) year = year - 543;

            const currentYear = new Date().getFullYear();
            if (year < 2020 || year > currentYear + 1) {
                alert(`‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏õ‡∏µ‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á 2020-${currentYear + 1}`);
                return;
            }

            if (zoneId) {
                const zone = ZONES_DATA.find(z => z.zone_id === zoneId);
                if (!zone) { alert('‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö Zone ‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å'); return; }
                closeAnnualReportModal();
                await generateAnnualReportForZone(year, zone, month);
                return;
            }

            closeAnnualReportModal();
            const container = document.getElementById('reportContainer');

            try {
                // ‡∏Å‡∏£‡∏ì‡∏µ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô (Single Month) -> ‡πÉ‡∏ä‡πâ API ‡πÄ‡∏î‡∏¥‡∏°‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢ ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á loop
                if (month) {
                    container.innerHTML = `
                        <div class="loading">
                            <div style="font-size: 48px; margin-bottom: 20px;">‚è≥</div>
                            <h3>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô ${month}/${year}</h3>
                            <p style="color: #666; margin-top: 10px;">‡πÇ‡∏õ‡∏£‡∏î‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà...</p>
                        </div>
                    `;
                    const params = new URLSearchParams({
                        year: year,
                        month: month,
                        branchId: branchId || ''
                    });
                    const response = await fetch(`/api/annual-report-data?${params.toString()}`);
                    const result = await response.json();
                    if (!response.ok || !result.success) throw new Error(result.error || `HTTP ${response.status}`);
                    displayAnnualReportTable(result);
                    return;
                }

                // ‡∏Å‡∏£‡∏ì‡∏µ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏õ‡∏µ (Annual) -> ‡πÉ‡∏ä‡πâ Loop Fetch 12 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô
                const result = await fetchAnnualBranchData(year, branchId, (current, total, monthName) => {
                    const progress = Math.round(((current - 1) / total) * 100);
                    container.innerHTML = `
                        <div class="loading">
                            <div style="font-size: 48px; margin-bottom: 20px;">‚è≥</div>
                            <h3>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏¢‡∏õ‡∏µ ${year}</h3>
                            <p style="color: #666; margin-top: 10px;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡πÄ‡∏î‡∏∑‡∏≠‡∏ô ${current}/${total} (${monthName})</p>
                            <div style="width: 100%; background: #e0e0e0; border-radius: 10px; height: 20px; margin-top: 15px; overflow: hidden;">
                                <div style="width: ${progress}%; background: #667eea; height: 100%; transition: width 0.3s;"></div>
                            </div>
                            <p style="color: #999; font-size: 12px; margin-top: 10px;">‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡∏•‡∏∞‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô Timeout</p>
                        </div>
                    `;
                });

                // result ‡∏à‡∏≤‡∏Å fetchAnnualBranchData ‡πÑ‡∏°‡πà‡∏°‡∏µ success: true ‡πÉ‡∏™‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ‡∏î‡πâ‡∏ß‡∏¢
                const finalResult = {
                    success: true,
                    year: year,
                    branch_id: result.branch_id,
                    branch_name: result.branch_name,
                    total_records: result.total_records,
                    total_agreed: result.total_agreed,
                    total_not_agreed: result.total_not_agreed,
                    monthly_data: result.monthly_data
                };

                displayAnnualReportTable(finalResult);

            } catch (error) {
                console.error('Error:', error);
                container.innerHTML = `<div class="error-message"><h3>‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î</h3><p>${error.message}</p></div>`;
            }
        }

        // Helper function ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏Ç‡∏≤ (‡πÄ‡∏û‡∏£‡∏≤‡∏∞ API ‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏≠‡∏≤‡∏à‡∏à‡∏∞‡πÑ‡∏°‡πà‡∏™‡πà‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏Ç‡∏≤‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤ ‡∏´‡∏£‡∏∑‡∏≠‡∏™‡πà‡∏á‡∏°‡∏≤‡∏ã‡πâ‡∏≥‡πÜ)
        async function getBranchName(branchId) {
            if (!branchId) return '‡∏ó‡∏∏‡∏Å‡∏™‡∏≤‡∏Ç‡∏≤';
            const branch = BRANCHES_DATA.find(b => b.branch_id == branchId || b.branch_id == String(branchId));
            return branch ? branch.branch_name : `‡∏™‡∏≤‡∏Ç‡∏≤ ${branchId}`;
        }


        async function generateAnnualReportForZone(year, zone, month = null) {
            const container = document.getElementById('reportContainer');
            const branchIds = zone.branch_ids;
            const branchesData = []; // ‡∏à‡∏∞‡πÄ‡∏Å‡πá‡∏ö‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
            let totalRecords = 0;

            // Helper function to process one branch
            const processBranch = async (branchId, index) => {
                try {
                    if (month) {
                        // Case: Single Month (Parallel Safe)
                        const params = new URLSearchParams({
                            year: year,
                            month: month,
                            branchId: branchId
                        });
                        const response = await fetch(`/api/annual-report-data?${params.toString()}`);
                        const result = await response.json();
                        if (response.ok && result.success) {
                            return {
                                branch_id: result.branch_id,
                                branch_name: result.branch_name,
                                total_records: result.total_records,
                                monthly_data: result.monthly_data || result.daily_data
                            };
                        } else {
                            const bName = await getBranchName(branchId);
                            return { branch_id: branchId, branch_name: bName, total_records: 0, monthly_data: [] };
                        }
                    } else {
                        // Case: Annual
                        // ‡πÉ‡∏ä‡πâ fetchAnnualBranchData helper (‡∏ã‡∏∂‡πà‡∏á fetch ‡∏ó‡∏µ‡∏•‡∏∞ 4 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô ‡πÅ‡∏ö‡∏ö Parallel ‡∏†‡∏≤‡∏¢‡πÉ‡∏ô‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß)
                        // ‡πÅ‡∏ï‡πà‡∏£‡∏≠‡∏ö‡∏ô‡∏µ‡πâ‡πÄ‡∏£‡∏≤‡∏à‡∏∞‡∏£‡∏±‡∏ô‡∏´‡∏•‡∏≤‡∏¢‡πÜ Store ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡∏±‡∏ô‡∏î‡πâ‡∏ß‡∏¢
                        const result = await fetchAnnualBranchData(year, branchId, null);
                        return result;
                    }
                } catch (e) {
                    console.error(e);
                    const bName = await getBranchName(branchId);
                    return { branch_id: branchId, branch_name: bName, total_records: 0, monthly_data: [] };
                }
            };

            // Chunk branches into batches of 2 (Safe Limit: 2 branches * 2 months = 4 concurrent requests)
            const batchSize = 2;
            for (let i = 0; i < branchIds.length; i += batchSize) {
                const batch = branchIds.slice(i, i + batchSize);

                // Update Progress UI (Batch Level)
                const currentBatch = Math.floor(i / batchSize) + 1;
                const totalBatches = Math.ceil(branchIds.length / batchSize);
                const progress = Math.round((i / branchIds.length) * 100);

                container.innerHTML = `
                    <div class="loading">
                        <div style="font-size: 48px; margin-bottom: 20px;">‚ö°</div>
                        <h3>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Zone: ${zone.zone_name} (Turbo Mode)</h3>
                        <p style="color: #333; font-weight: bold; margin-top: 10px;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏ä‡∏∏‡∏î‡∏ó‡∏µ‡πà ${currentBatch} / ${totalBatches}</p>
                        <p style="color: #666; font-size: 14px; margin-top: 5px;">
                            (‡∏™‡∏≤‡∏Ç‡∏≤‡∏ó‡∏µ‡πà ${i + 1} - ${Math.min(i + batchSize, branchIds.length)} ‡∏à‡∏≤‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ${branchIds.length} ‡∏™‡∏≤‡∏Ç‡∏≤)
                        </p>
                        <div style="width: 100%; background: #e0e0e0; border-radius: 10px; height: 20px; margin-top: 15px; overflow: hidden;">
                            <div style="width: ${progress}%; background: #667eea; height: 100%; transition: width 0.3s;"></div>
                        </div>
                        <p style="color: #999; font-size: 12px; margin-top: 10px;">‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏•‡∏≤‡∏¢‡∏™‡∏≤‡∏Ç‡∏≤‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡∏±‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏ß‡∏î‡πÄ‡∏£‡πá‡∏ß...</p>
                    </div>
                `;

                // Run batch in parallel
                const results = await Promise.all(batch.map((bid, idx) => processBranch(bid, i + idx)));

                results.forEach(res => {
                    if (res) {
                        totalRecords += (res.total_records || 0);
                        branchesData.push(res);
                    }
                });

                // Short break to be gentle
                await new Promise(r => setTimeout(r, 100));
            }

            const combinedResult = {
                success: true,
                year: year,
                month: month,
                zone_id: zone.zone_id,
                zone_name: zone.zone_name,
                branch_count: branchIds.length,
                total_records: totalRecords,
                branches_data: branchesData
            };

            displayAnnualReportTableForZone(combinedResult);
        }

        function displayAnnualReportTable(data) {
            const container = document.getElementById('reportContainer');
            let branchInfo;

            if (data.zone_name) {
                branchInfo = `üó∫Ô∏è Zone: ${data.zone_name} (${data.branch_count} ‡∏™‡∏≤‡∏Ç‡∏≤)`;
            } else if (data.branch_name) {
                branchInfo = `‡∏™‡∏≤‡∏Ç‡∏≤: ${data.branch_name}`;
            } else {
                branchInfo = '‡∏ó‡∏∏‡∏Å‡∏™‡∏≤‡∏Ç‡∏≤';
            }

            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô (daily_data) ‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏≤‡∏¢‡∏õ‡∏µ (monthly_data)
            const isMonthlyReport = data.daily_data !== undefined;
            const reportData = isMonthlyReport ? data.daily_data : data.monthly_data;

            const month_names_th = ['‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°', '‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå', '‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°', '‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô', '‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°', '‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô',
                '‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°', '‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°', '‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô', '‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°', '‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô', '‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°'];

            // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì totals
            let totalAll = 0, totalAgreed = 0;
            reportData.forEach(item => {
                totalAll += (item.count || 0);
                totalAgreed += (item.agreed || 0);
            });
            const totalNotAgreed = totalAll - totalAgreed;

            // ‡∏™‡∏£‡πâ‡∏≤‡∏á HTML ‡∏ï‡∏≤‡∏£‡∏≤‡∏á
            let html = `
                <div style="background: #f8f9fa; padding: 15px; border-radius: 10px; margin-bottom: 20px; border-left: 4px solid #667eea;">
                    <h3 style="margin: 0; color: #667eea;">üìä ${isMonthlyReport ? '‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô ' + month_names_th[data.month - 1] : '‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏£‡∏≤‡∏¢‡∏õ‡∏µ'} ${data.year}</h3>
                    <p style="margin: 5px 0 0 0; color: #666;">${branchInfo} | ‡∏£‡∏ß‡∏° ${totalAll} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ (‡∏ï‡∏Å‡∏•‡∏á ${totalAgreed} | ‡πÑ‡∏°‡πà‡∏ï‡∏Å‡∏•‡∏á ${totalNotAgreed})</p>
                </div>
                
                <div style="text-align: right; margin-bottom: 15px;">
                    <button onclick="exportAnnualReportToExcelFromData()" 
                            style="background: #28a745; padding: 10px 20px; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 14px;">
                        üì• Export Excel
                    </button>
                </div>
                
                <div class="data-table">
                    <table>
                        <thead>
                            <tr>
                                <th style="background: #667eea; color: white;">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</th>
            `;

            // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡∏±‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á
            if (isMonthlyReport) {
                reportData.forEach(day => {
                    html += `<th style="background: #4472C4; color: white;">${day.day}</th>`;
                });
            } else {
                reportData.forEach(month => {
                    html += `<th style="background: #4472C4; color: white;">${month.month}</th>`;
                });
            }
            html += `<th style="background: #28a745; color: white;">‡∏£‡∏ß‡∏°</th></tr></thead><tbody>`;

            // ‡πÅ‡∏ñ‡∏ß 1: ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
            html += `<tr><td style="background: #FFF2CC; font-weight: bold;">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</td>`;
            let rowTotalAll = 0;
            reportData.forEach(item => {
                const count = item.count || 0;
                const bgColor = count > 0 ? '#E7E6E6' : '';
                html += `<td style="text-align: center; background: ${bgColor};">${count}</td>`;
                rowTotalAll += count;
            });
            html += `<td style="text-align: center; background: #FFF2CC; font-weight: bold;">${rowTotalAll}</td></tr>`;

            // ‡πÅ‡∏ñ‡∏ß 2: ‡∏ï‡∏Å‡∏•‡∏á‡πÄ‡∏ó‡∏£‡∏î
            html += `<tr><td style="background: #d4edda; font-weight: bold;">‡∏ï‡∏Å‡∏•‡∏á‡πÄ‡∏ó‡∏£‡∏î</td>`;
            let rowTotalAgreed = 0;
            reportData.forEach(item => {
                const count = item.agreed || 0;
                const bgColor = count > 0 ? '#E7E6E6' : '';
                html += `<td style="text-align: center; background: ${bgColor};">${count}</td>`;
                rowTotalAgreed += count;
            });
            html += `<td style="text-align: center; background: #d4edda; font-weight: bold;">${rowTotalAgreed}</td></tr>`;

            // ‡πÅ‡∏ñ‡∏ß 3: ‡πÑ‡∏°‡πà‡∏ï‡∏Å‡∏•‡∏á
            html += `<tr><td style="background: #f8d7da; font-weight: bold;">‡πÑ‡∏°‡πà‡∏ï‡∏Å‡∏•‡∏á</td>`;
            let rowTotalNotAgreed = 0;
            reportData.forEach(item => {
                const count = (item.count || 0) - (item.agreed || 0);
                const bgColor = count > 0 ? '#E7E6E6' : '';
                html += `<td style="text-align: center; background: ${bgColor};">${count}</td>`;
                rowTotalNotAgreed += count;
            });
            html += `<td style="text-align: center; background: #f8d7da; font-weight: bold;">${rowTotalNotAgreed}</td></tr>`;

            html += `
                        </tbody>
                    </table>
                </div>
                
                <div style="margin-top: 30px;">
                    <canvas id="annualChart" style="max-height: 400px;"></canvas>
                </div>
            `;

            container.innerHTML = html;

            // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏£‡∏≤‡∏ü
            createAnnualChart(reportData, isMonthlyReport);

            // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏ß‡πâ‡πÉ‡∏ä‡πâ export
            window.currentAnnualReportData = data;
        }

        function displayAnnualReportTableForZone(data) {
            const container = document.getElementById('reportContainer');

            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô (daily_data) ‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏≤‡∏¢‡∏õ‡∏µ (monthly_data)
            const firstBranch = data.branches_data[0];
            const isMonthlyReport = firstBranch && firstBranch.monthly_data && firstBranch.monthly_data[0] && firstBranch.monthly_data[0].day !== undefined;

            const month_names_th = ['‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°', '‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå', '‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°', '‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô', '‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°', '‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô',
                '‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°', '‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°', '‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô', '‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°', '‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô', '‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°'];

            // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì totals
            let grandTotalAll = 0, grandTotalAgreed = 0;
            data.branches_data.forEach(branch => {
                branch.monthly_data.forEach(item => {
                    grandTotalAll += (item.count || 0);
                    grandTotalAgreed += (item.agreed || 0);
                });
            });
            const grandTotalNotAgreed = grandTotalAll - grandTotalAgreed;

            // ‡∏™‡∏£‡πâ‡∏≤‡∏á HTML ‡∏ï‡∏≤‡∏£‡∏≤‡∏á
            let html = `
                <div style="background: #f8f9fa; padding: 15px; border-radius: 10px; margin-bottom: 20px; border-left: 4px solid #667eea;">
                    <h3 style="margin: 0; color: #667eea;">üìä ${isMonthlyReport ? '‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô ' + month_names_th[(data.month || 1) - 1] : '‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏£‡∏≤‡∏¢‡∏õ‡∏µ'} ${data.year}</h3>
                    <p style="margin: 5px 0 0 0; color: #666;">üó∫Ô∏è Zone: ${data.zone_name} (${data.branch_count} ‡∏™‡∏≤‡∏Ç‡∏≤) | ‡∏£‡∏ß‡∏° ${grandTotalAll} (‡∏ï‡∏Å‡∏•‡∏á ${grandTotalAgreed} | ‡πÑ‡∏°‡πà‡∏ï‡∏Å‡∏•‡∏á ${grandTotalNotAgreed})</p>
                </div>
                
                <div style="text-align: right; margin-bottom: 15px;">
                    <button onclick="exportAnnualReportToExcelFromData()" 
                            style="background: #28a745; padding: 10px 20px; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 14px;">
                        üì• Export Excel
                    </button>
                </div>
                
                <div class="data-table">
                    <table>
                        <thead>
                            <tr>
                                <th style="background: #667eea; color: white;">‡∏™‡∏≤‡∏Ç‡∏≤</th>
                                <th style="background: #667eea; color: white;">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</th>
            `;

            // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡∏±‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ï‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô
            let numCols;
            if (isMonthlyReport) {
                const sampleData = firstBranch.monthly_data;
                numCols = sampleData.length;
                sampleData.forEach(day => {
                    html += `<th style="background: #4472C4; color: white;">${day.day}</th>`;
                });
            } else {
                const monthNames = ['JAN', 'FEB', 'MAR', 'APR', 'MAY', 'JUN', 'JUL', 'AUG', 'SEP', 'OCT', 'NOV', 'DEC'];
                numCols = 12;
                monthNames.forEach(month => {
                    html += `<th style="background: #4472C4; color: white;">${month}</th>`;
                });
            }

            html += `<th style="background: #28a745; color: white;">‡∏£‡∏ß‡∏°</th></tr></thead><tbody>`;

            // ‡∏Ñ‡πà‡∏≤‡∏£‡∏ß‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏ñ‡∏ß total
            let totalAllByPeriod = new Array(numCols).fill(0);
            let totalAgreedByPeriod = new Array(numCols).fill(0);

            // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏ñ‡∏ß‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏™‡∏≤‡∏Ç‡∏≤ (3 ‡πÅ‡∏ñ‡∏ß‡∏ï‡πà‡∏≠‡∏™‡∏≤‡∏Ç‡∏≤)
            const rowConfigs = [
                { label: '‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î', key: 'count', color: '#FFF2CC' },
                { label: '‡∏ï‡∏Å‡∏•‡∏á‡πÄ‡∏ó‡∏£‡∏î', key: 'agreed', color: '#d4edda' },
                { label: '‡πÑ‡∏°‡πà‡∏ï‡∏Å‡∏•‡∏á', key: 'not_agreed', color: '#f8d7da' }
            ];

            data.branches_data.forEach(branch => {
                const branchName = branch.branch_name ? branch.branch_name.split(' : ').pop() : `‡∏™‡∏≤‡∏Ç‡∏≤ ${branch.branch_id}`;

                rowConfigs.forEach((config, configIdx) => {
                    html += `<tr>`;

                    // ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏™‡∏≤‡∏Ç‡∏≤ (‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÅ‡∏ñ‡∏ß‡πÅ‡∏£‡∏Å)
                    if (configIdx === 0) {
                        html += `<td style="background: ${config.color}; font-weight: bold;" rowspan="3">${branchName}</td>`;
                    }

                    // ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
                    html += `<td style="background: ${config.color}; font-size: 11px;">${config.label}</td>`;

                    let rowTotal = 0;
                    branch.monthly_data.forEach((item, idx) => {
                        let count;
                        if (config.key === 'count') {
                            count = item.count || 0;
                            totalAllByPeriod[idx] += count;
                        } else if (config.key === 'agreed') {
                            count = item.agreed || 0;
                            totalAgreedByPeriod[idx] += count;
                        } else {
                            count = (item.count || 0) - (item.agreed || 0);
                        }

                        const bgColor = count > 0 ? '#E7E6E6' : '';
                        html += `<td style="text-align: center; background: ${bgColor};">${count}</td>`;
                        rowTotal += count;
                    });

                    html += `<td style="text-align: center; background: ${config.color}; font-weight: bold;">${rowTotal}</td>`;
                    html += `</tr>`;
                });
            });

            // ‡πÅ‡∏ñ‡∏ß‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (3 ‡πÅ‡∏ñ‡∏ß)
            rowConfigs.forEach((config, configIdx) => {
                html += `<tr style="font-weight: bold;">`;

                if (configIdx === 0) {
                    html += `<td style="background: #667eea; color: white;" rowspan="3">‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</td>`;
                }

                html += `<td style="background: #667eea; color: white; font-size: 11px;">${config.label}</td>`;

                let rowTotal = 0;
                for (let i = 0; i < numCols; i++) {
                    let count;
                    if (config.key === 'count') {
                        count = totalAllByPeriod[i];
                    } else if (config.key === 'agreed') {
                        count = totalAgreedByPeriod[i];
                    } else {
                        count = totalAllByPeriod[i] - totalAgreedByPeriod[i];
                    }
                    html += `<td style="text-align: center; background: #d1ecf1;">${count}</td>`;
                    rowTotal += count;
                }

                html += `<td style="text-align: center; background: #28a745; color: white;">${rowTotal}</td>`;
                html += `</tr>`;
            });

            html += `
                        </tbody>
                    </table>
                </div>
                
                <div style="margin-top: 30px;">
                    <canvas id="annualChart" style="max-height: 400px;"></canvas>
                </div>
            `;

            container.innerHTML = html;

            // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏£‡∏≤‡∏ü‡∏£‡∏ß‡∏°
            let chartData;
            if (isMonthlyReport) {
                chartData = totalAllByPeriod.map((count, idx) => ({
                    day: idx + 1,
                    count: count
                }));
            } else {
                const monthNames = ['JAN', 'FEB', 'MAR', 'APR', 'MAY', 'JUN', 'JUL', 'AUG', 'SEP', 'OCT', 'NOV', 'DEC'];
                chartData = totalAllByPeriod.map((count, idx) => ({
                    month: monthNames[idx],
                    count: count
                }));
            }

            createAnnualChart(chartData, isMonthlyReport);

            // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏ß‡πâ‡πÉ‡∏ä‡πâ export
            window.currentAnnualReportData = data;
        }

        function createAnnualChart(reportData, isMonthlyReport) {
            const ctx = document.getElementById('annualChart');
            if (!ctx) return;

            // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Å‡∏£‡∏≤‡∏ü‡πÄ‡∏Å‡πà‡∏≤‡∏≠‡∏¢‡∏π‡πà ‡πÉ‡∏´‡πâ‡∏ó‡∏≥‡∏•‡∏≤‡∏¢‡∏Å‡πà‡∏≠‡∏ô
            if (window.annualChartInstance) {
                window.annualChartInstance.destroy();
            }

            // ‡∏™‡∏£‡πâ‡∏≤‡∏á labels ‡πÅ‡∏•‡∏∞ data ‡∏ï‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô
            let labels, counts, chartTitle;

            if (isMonthlyReport) {
                // ‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô - ‡πÅ‡∏™‡∏î‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà
                labels = reportData.map(d => `${d.day}`);
                counts = reportData.map(d => d.count);
                chartTitle = '‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏ó‡∏£‡∏î‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô';
            } else {
                // ‡∏£‡∏≤‡∏¢‡∏õ‡∏µ - ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏î‡∏∑‡∏≠‡∏ô
                labels = reportData.map(m => m.month);
                counts = reportData.map(m => m.count);
                chartTitle = '‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏ó‡∏£‡∏î‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô';
            }

            window.annualChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏ó‡∏£‡∏î',
                        data: counts,
                        backgroundColor: 'rgba(102, 126, 234, 0.5)',
                        borderColor: 'rgba(102, 126, 234, 1)',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        title: {
                            display: true,
                            text: chartTitle,
                            font: { size: 16 }
                        },
                        legend: {
                            display: true
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 10
                            }
                        }
                    }
                }
            });
        }

        async function exportAnnualReportToExcelFromData() {
            // Export ‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡πÅ‡∏™‡∏î‡∏á‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö (‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏î‡∏∂‡∏á‡πÉ‡∏´‡∏°‡πà)
            if (!window.currentAnnualReportData) {
                alert('‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Å‡πà‡∏≠‡∏ô');
                return;
            }

            const data = window.currentAnnualReportData;

            // ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏õ‡πÉ‡∏´‡πâ backend ‡∏™‡∏£‡πâ‡∏≤‡∏á Excel
            try {
                const button = event.target;
                const originalText = button.innerHTML;
                button.disabled = true;
                button.innerHTML = '‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á Export...';

                const response = await fetch('/api/annual-report-excel-from-data', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }

                // ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;

                // ‡∏ï‡∏±‡πâ‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå
                let filename;
                if (data.zone_name) {
                    filename = `trade_report_${data.year}_zone_${data.zone_name}.xlsx`;
                } else if (data.branch_name) {
                    filename = `trade_report_${data.year}_${data.branch_name}.xlsx`;
                } else {
                    filename = `trade_report_${data.year}.xlsx`;
                }

                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);

                button.disabled = false;
                button.innerHTML = originalText;

                alert('‚úÖ Export Excel ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!');

            } catch (error) {
                console.error('Error exporting Excel:', error);
                alert('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message);

                if (event && event.target) {
                    event.target.disabled = false;
                    event.target.innerHTML = 'üì• Export Excel';
                }
            }
        }

        async function exportAnnualReportToExcel(year, branchId, zoneId) {
            try {
                const button = event.target;
                const originalText = button.innerHTML;
                button.disabled = true;
                button.innerHTML = '‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á Export...';

                const params = new URLSearchParams({
                    year: year
                });

                if (zoneId) {
                    params.append('zoneId', zoneId);
                } else if (branchId) {
                    params.append('branchId', branchId);
                }

                const response = await fetch(`/api/annual-report-excel-v2?${params.toString()}`);

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }

                // ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;

                // ‡∏ï‡∏±‡πâ‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå
                let filename;
                if (zoneId) {
                    const zone = ZONES_DATA.find(z => z.zone_id == zoneId);
                    const zoneName = zone ? zone.zone_name : zoneId;
                    filename = `trade_report_${year}_zone_${zoneName}.xlsx`;
                } else if (branchId) {
                    const branchName = BRANCHES_DATA.find(b => b.branch_id == branchId)?.branch_name || branchId;
                    filename = `trade_report_${year}_${branchName}.xlsx`;
                } else {
                    filename = `trade_report_${year}_all_branches.xlsx`;
                }

                a.download = filename;

                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);

                button.disabled = false;
                button.innerHTML = originalText;

                alert('‚úÖ Export Excel ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!');

            } catch (error) {
                console.error('Error exporting Excel:', error);
                alert('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message);

                if (event && event.target) {
                    event.target.disabled = false;
                    event.target.innerHTML = 'üì• Export Excel';
                }
            }
        }

        // autoFetchSession() ‡∏ñ‡∏π‡∏Å‡∏•‡∏ö‡∏≠‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß ‚Äî ‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏ä‡πâ Auto-Login

        // ‡∏õ‡∏¥‡∏î modal ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ô‡∏≠‡∏Å modal
        window.onclick = function (event) {
            const modal = document.getElementById('settingsModal');
            if (event.target == modal) {
                closeSettings();
            }
        }

        async function loginToSystem() {
            const username = localStorage.getItem('username') || '';
            const password = localStorage.getItem('password') || '';

            if (!username || !password) {
                throw new Error('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• login ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Å‡πà‡∏≠‡∏ô');
            }

            try {
                const response = await fetch('/api/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        username: username,
                        password: password
                    })
                });

                const result = await response.json();

                if (!result.success) {
                    throw new Error(result.error || 'Login ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
                }

                return result.cookies;
            } catch (error) {
                throw new Error(`Login ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ${error.message}`);
            }
        }

        document.getElementById('searchForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            await searchData();
        });

        function resetForm() {
            document.getElementById('searchForm').reset();
            const today = new Date();
            const yesterday = new Date(today);
            yesterday.setDate(yesterday.getDate() - 1);
            document.getElementById('dateStart').valueAsDate = yesterday;
            document.getElementById('dateEnd').valueAsDate = today;
        }

        function formatDateThai(dateStr) {
            const date = new Date(dateStr);
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = date.getFullYear(); // ‡πÉ‡∏ä‡πâ ‡∏Ñ.‡∏®.
            return `${day}/${month}/${year}`;
        }

        async function searchData() {
            const container = document.getElementById('dataContainer');
            const submitBtn = document.querySelector('button[type="submit"]');

            container.innerHTML = '<div class="loading">‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</div>';
            submitBtn.disabled = true;

            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Zone ‡∏´‡∏£‡∏∑‡∏≠‡∏™‡∏≤‡∏Ç‡∏≤‡πÄ‡∏î‡∏µ‡πà‡∏¢‡∏ß
            const zoneSelect = document.getElementById('zoneSelect');
            const branchSelect = document.getElementById('branchSelect');
            const selectedZone = zoneSelect.value;

            let branchIds = [];
            if (selectedZone) {
                // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Zone ‡πÉ‡∏´‡πâ‡∏î‡∏∂‡∏á‡∏™‡∏≤‡∏Ç‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ô Zone
                branchIds = ZoneHelper.getBranchIdsByZone(selectedZone);
                console.log(`üó∫Ô∏è ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ Zone: ${selectedZone}, ‡∏™‡∏≤‡∏Ç‡∏≤: ${branchIds.join(', ')}`);
            } else {
                // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏≤‡∏Ç‡∏≤‡πÄ‡∏î‡∏µ‡πà‡∏¢‡∏ß
                const branchId = branchSelect.value || loadSavedBranch();
                branchIds = [branchId];
            }

            // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô Zone (‡∏´‡∏•‡∏≤‡∏¢‡∏™‡∏≤‡∏Ç‡∏≤) ‡πÉ‡∏´‡πâ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡∏•‡∏∞‡∏™‡∏≤‡∏Ç‡∏≤‡πÅ‡∏•‡πâ‡∏ß‡∏£‡∏ß‡∏°‡∏Å‡∏±‡∏ô
            if (branchIds.length > 1) {
                await searchMultipleBranches(branchIds, container, submitBtn);
            } else {
                // ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏™‡∏≤‡∏Ç‡∏≤‡πÄ‡∏î‡∏µ‡∏¢‡∏ß (‡πÅ‡∏ö‡∏ö‡πÄ‡∏î‡∏¥‡∏°)
                await searchSingleBranch(branchIds[0], container, submitBtn);
            }
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏™‡∏≤‡∏Ç‡∏≤‡πÄ‡∏î‡∏µ‡∏¢‡∏ß
        async function searchSingleBranch(branchId, container, submitBtn) {
            const params = new URLSearchParams({
                branchId: branchId,
                saleCode: document.getElementById('saleCode').value,
                dateStart: formatDateThai(document.getElementById('dateStart').value),
                dateEnd: formatDateThai(document.getElementById('dateEnd').value),
                status: document.getElementById('status').value,
                brand: document.getElementById('brand').value,
                series: document.getElementById('series').value,
                docRefType: document.getElementById('docRefType').value,
                docRefNumber: document.getElementById('docRefNumber').value,
                promoCode: document.getElementById('promoCode').value,
                customerSign: document.getElementById('customerSign').value
            });

            try {
                const response = await fetch(`/api/data?${params}`);
                const data = await response.json();

                if (data.error) {
                    container.innerHTML = `
                        <div class="error">
                            <h3>‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î</h3>
                            <p>${data.error}</p>
                        </div>
                    `;
                } else {
                    displayData(data);
                }
            } catch (error) {
                container.innerHTML = `
                    <div class="error">
                        <h3>‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î</h3>
                        <p>${error.message}</p>
                    </div>
                `;
            } finally {
                submitBtn.disabled = false;
            }
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏´‡∏•‡∏≤‡∏¢‡∏™‡∏≤‡∏Ç‡∏≤ (Zone)
        async function searchMultipleBranches(branchIds, container, submitBtn) {
            try {
                let allData = [];
                let totalRecords = 0;

                // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡∏•‡∏∞‡∏™‡∏≤‡∏Ç‡∏≤
                for (let i = 0; i < branchIds.length; i++) {
                    const branchId = branchIds[i];
                    container.innerHTML = `<div class="loading">‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•... (${i + 1}/${branchIds.length} ‡∏™‡∏≤‡∏Ç‡∏≤)</div>`;

                    const params = new URLSearchParams({
                        branchId: branchId,
                        saleCode: document.getElementById('saleCode').value,
                        dateStart: formatDateThai(document.getElementById('dateStart').value),
                        dateEnd: formatDateThai(document.getElementById('dateEnd').value),
                        status: document.getElementById('status').value,
                        brand: document.getElementById('brand').value,
                        series: document.getElementById('series').value,
                        docRefType: document.getElementById('docRefType').value,
                        docRefNumber: document.getElementById('docRefNumber').value,
                        promoCode: document.getElementById('promoCode').value,
                        customerSign: document.getElementById('customerSign').value
                    });

                    const response = await fetch(`/api/data?${params}`);
                    const data = await response.json();

                    if (data.error) {
                        console.error(`‚ùå ‡∏™‡∏≤‡∏Ç‡∏≤ ${branchId}: ${data.error}`);
                    } else {
                        allData = allData.concat(data.data || []);
                        totalRecords += data.recordsTotal || 0;
                    }
                }

                // ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏£‡∏ß‡∏°
                displayData({
                    data: allData,
                    recordsTotal: totalRecords,
                    recordsFiltered: allData.length
                });

                console.log(`‚úÖ ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ ${branchIds.length} ‡∏™‡∏≤‡∏Ç‡∏≤‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô, ‡∏û‡∏ö ${allData.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`);
            } catch (error) {
                container.innerHTML = `
                    <div class="error">
                        <h3>‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î</h3>
                        <p>${error.message}</p>
                    </div>
                `;
            } finally {
                submitBtn.disabled = false;
            }
        }

        function displayData(data) {
            const container = document.getElementById('dataContainer');

            // ‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏£‡∏∏‡∏õ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
            const recordsTotal = data.recordsTotal || 0;
            const recordsFiltered = data.recordsFiltered || recordsTotal;
            const dataArray = data.data || [];

            let html = `
                <div class="summary">
                    <span class="summary-item">üìä ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: ${recordsTotal} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</span>
                    <span class="summary-item">üîç ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤: ${recordsFiltered} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</span>
                    <span class="summary-item">üìÑ ‡πÅ‡∏™‡∏î‡∏á: ${dataArray.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</span>
                </div>
            `;

            if (dataArray.length === 0) {
                html += '<p style="text-align: center; color: #999; padding: 50px;">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p>';
            } else {
                html += `
                    <div class="action-bar">
                        <div>
                            <span id="selectedCount" style="font-weight: 600;">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å: 0 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</span>
                        </div>
                        <div>
                            <button onclick="selectAll()" class="secondary">‚úÖ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
                            <button onclick="deselectAll()" class="secondary" style="margin-left: 10px;">‚ùå ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</button>
                            <button onclick="cancelSelected()" class="danger" style="margin-left: 10px;">üóëÔ∏è ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</button>
                        </div>
                    </div>
                    <div class="table-wrapper">
                `;
                html += createTable(dataArray);
                html += '</div>';
            }

            container.innerHTML = html;
        }

        function createTable(dataArray) {
            // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡πÅ‡∏•‡∏∞‡∏ä‡∏∑‡πà‡∏≠‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢
            const columns = [
                { key: 'document_no', label: '‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡πÄ‡∏ó‡∏£‡∏î' },
                { key: 'IS_SIGNED', label: '‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤', format: (v) => v === '1' ? '‚úÖ ‡πÄ‡∏ã‡πá‡∏ô‡πÅ‡∏•‡πâ‡∏ß' : '‚ùå ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏ã‡πá‡∏ô' },
                { key: 'SIGN_DATE', label: '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏Ñ‡∏∑‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á' },
                { key: 'document_date', label: '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡πÄ‡∏ó‡∏£‡∏î' },
                { key: 'series', label: '‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤' },
                { key: 'category_name', label: '‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤' },
                { key: 'brand_name', label: '‡πÅ‡∏ö‡∏£‡∏ô‡∏î‡πå' },
                { key: 'part_number', label: '‡∏≠‡∏µ‡∏°‡∏µ‡πà/‡∏ã‡∏µ‡πÄ‡∏£‡∏µ‡∏¢‡∏•' },
                { key: 'amount', label: '‡∏£‡∏≤‡∏Ñ‡∏≤‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô', format: (v) => v ? parseFloat(v).toLocaleString('th-TH', { minimumFractionDigits: 2 }) : '-' },
                { key: 'COUPON_TRADE_IN_CODE', label: '‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î‡∏Ñ‡πà‡∏≤‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á' },
                { key: 'invoice_no', label: '‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏ö‡∏¥‡∏•‡∏Ç‡∏≤‡∏¢' },
                { key: 'CAMPAIGN_ON_TOP_NAME', label: '‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î‡πÅ‡∏ö‡∏£‡∏ô‡∏î‡πå' },
                { key: 'COUPON_ON_TOP_BRAND_CODE', label: '‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î‡πÅ‡∏ö‡∏£‡∏ô‡∏î‡πå' },
                { key: 'COUPON_ON_TOP_BRAND_PRICE', label: '‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î‡πÅ‡∏ö‡∏£‡∏ô‡∏î‡πå', format: (v) => v ? parseFloat(v).toLocaleString('th-TH', { minimumFractionDigits: 2 }) : '-' },
                { key: 'COUPON_ON_TOP_COMPANY_CODE', label: '‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó' },
                { key: 'COUPON_ON_TOP_COMPANY_PRICE', label: '‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó', format: (v) => v ? parseFloat(v).toLocaleString('th-TH', { minimumFractionDigits: 2 }) : '-' },
                { key: 'customer_name', label: '‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏Ç‡∏≤‡∏¢' },
                { key: 'customer_phone_number', label: '‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå‡∏ú‡∏π‡πâ‡∏Ç‡∏≤‡∏¢' },
                { key: 'customer_email', label: '‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πå‡∏ú‡∏π‡πâ‡∏Ç‡∏≤‡∏¢' },
                { key: 'buyer_name', label: '‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ã‡∏∑‡πâ‡∏≠' },
                { key: 'SALE_CODE', label: '‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Ç‡∏≤‡∏¢' },
                { key: 'SALE_NAME', label: '‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Ç‡∏≤‡∏¢' },
                { key: 'DOCUMENT_REF_1', label: '‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á' },
                { key: 'BIDDING_STATUS_NAME', label: '‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞' },
                { key: 'CHANGE_REQUEST_COUNT', label: '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç' }
            ];

            let table = '<table class="data-table"><thead><tr>';

            // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå checkbox
            table += '<th class="checkbox-cell"><input type="checkbox" id="selectAllCheckbox" onchange="toggleSelectAll()"></th>';

            // ‡∏™‡∏£‡πâ‡∏≤‡∏á header
            columns.forEach(col => {
                table += `<th>${col.label}</th>`;
            });
            table += '</tr></thead><tbody>';

            // ‡∏™‡∏£‡πâ‡∏≤‡∏á rows
            dataArray.forEach((item, index) => {
                const tradeInId = item.trade_in_id || '';
                const docNo = item.document_no || '';
                table += `<tr id="row-${index}" data-tradein-id="${tradeInId}" data-doc-no="${docNo}">`;

                // ‡πÄ‡∏û‡∏¥‡πà‡∏° checkbox
                table += `<td class="checkbox-cell"><input type="checkbox" class="row-checkbox" onchange="updateSelectedCount()"></td>`;

                columns.forEach(col => {
                    const value = item[col.key];
                    let displayValue = value === null || value === undefined || value === '' ? '-' : value;

                    // ‡πÉ‡∏ä‡πâ format function ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ
                    if (col.format && value) {
                        displayValue = col.format(value);
                    }

                    table += `<td>${displayValue}</td>`;
                });
                table += '</tr>';
            });

            table += '</tbody></table>';
            return table;
        }

        function toggleSelectAll() {
            const selectAllCheckbox = document.getElementById('selectAllCheckbox');
            const checkboxes = document.querySelectorAll('.row-checkbox');
            checkboxes.forEach(cb => {
                cb.checked = selectAllCheckbox.checked;
                const row = cb.closest('tr');
                if (cb.checked) {
                    row.classList.add('selected-row');
                } else {
                    row.classList.remove('selected-row');
                }
            });
            updateSelectedCount();
        }

        function selectAll() {
            document.getElementById('selectAllCheckbox').checked = true;
            toggleSelectAll();
        }

        function deselectAll() {
            document.getElementById('selectAllCheckbox').checked = false;
            toggleSelectAll();
        }

        function updateSelectedCount() {
            const checkboxes = document.querySelectorAll('.row-checkbox:checked');
            const count = checkboxes.length;
            document.getElementById('selectedCount').textContent = `‡πÄ‡∏•‡∏∑‡∏≠‡∏Å: ${count} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`;

            // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó highlight ‡πÅ‡∏ñ‡∏ß
            document.querySelectorAll('.row-checkbox').forEach(cb => {
                const row = cb.closest('tr');
                if (cb.checked) {
                    row.classList.add('selected-row');
                } else {
                    row.classList.remove('selected-row');
                }
            });
        }

        async function cancelSelected() {
            const checkboxes = document.querySelectorAll('.row-checkbox:checked');

            if (checkboxes.length === 0) {
                alert('‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å');
                return;
            }

            // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏à‡∏≤‡∏Å localStorage
            const empCode = localStorage.getItem('empCode') || '';
            const empName = localStorage.getItem('empName') || '';
            const empPhone = localStorage.getItem('empPhone') || '';
            const cancelType = localStorage.getItem('cancelType') || '1';
            const reasonCancel = localStorage.getItem('reasonCancel') || '1';

            if (!empCode || !empName || !empPhone) {
                alert('‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Å‡πà‡∏≠‡∏ô (‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° ‚öôÔ∏è ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô)');
                return;
            }

            const tradeInIds = [];
            const docNos = [];

            checkboxes.forEach(cb => {
                const row = cb.closest('tr');
                const tradeInId = row.dataset.tradeinId;
                const docNo = row.dataset.docNo;
                if (tradeInId) tradeInIds.push(tradeInId);
                if (docNo) docNos.push(docNo);
            });

            // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÉ‡∏ä‡πâ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
            const cancelTypeText = cancelType === '1' ? '‡πÇ‡∏î‡∏ô‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏à‡∏≤‡∏Å‡∏ú‡∏π‡πâ‡∏Ç‡∏≤‡∏¢' : '‡∏≠‡∏∑‡πà‡∏ô‡πÜ';
            const reasonCancelText = reasonCancel === '1' ? '‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÉ‡∏à‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÑ‡∏ß‡πâ‡πÉ‡∏ä‡πâ‡πÄ‡∏≠‡∏á' :
                reasonCancel === '2' ? '‡∏£‡∏≤‡∏Ñ‡∏≤‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£' : '‡∏≠‡∏∑‡πà‡∏ô‡πÜ';


            const reason = prompt('‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ):', reasonCancelText);
            if (reason === null) return;

            // === ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô 1: Pre-check ‡∏ó‡∏∏‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Å‡πà‡∏≠‡∏ô‡πÅ‡∏™‡∏î‡∏á confirm ===
            const originalBtn = event.target;
            originalBtn.disabled = true;
            originalBtn.textContent = 'üîç ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞...';

            const canCancelIds = [];
            const canCancelDocs = [];
            const alreadyCancelled = [];

            for (let i = 0; i < tradeInIds.length; i++) {
                const tradeInId = tradeInIds[i];
                const docNo = docNos[i] || tradeInId;
                try {
                    const checkResponse = await fetch('/api/check-cancel', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ tradeInId: tradeInId })
                    });

                    if (checkResponse.ok) {
                        const checkResult = await checkResponse.json();
                        const canCancel = checkResult.d?.is_success || checkResult.d?.allow_cancel || checkResult.d?.success;

                        if (canCancel) {
                            canCancelIds.push(tradeInId);
                            canCancelDocs.push(docNo);
                        } else {
                            const msg = checkResult.d?.message || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÑ‡∏î‡πâ';
                            alreadyCancelled.push(`${docNo}: ${Array.isArray(msg) ? msg.join(', ') : msg}`);
                        }
                    } else {
                        alreadyCancelled.push(`${docNo}: ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à`);
                    }
                } catch (error) {
                    alreadyCancelled.push(`${docNo}: ${error.message}`);
                }
            }

            // === ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô 2: ‡πÅ‡∏à‡πâ‡∏á‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö ===
            if (canCancelIds.length === 0) {
                let msg = `‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÑ‡∏î‡πâ (${alreadyCancelled.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ñ‡∏π‡∏Å‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï)`;
                if (alreadyCancelled.length > 0) {
                    msg += '\n\n‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î:\n' + alreadyCancelled.slice(0, 10).join('\n');
                }
                alert(msg);
                originalBtn.disabled = false;
                originalBtn.textContent = 'üóëÔ∏è ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å';
                return;
            }

            // ‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏£‡∏∏‡∏õ‡∏Å‡πà‡∏≠‡∏ô confirm
            let preCheckMsg = `‚úÖ ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÑ‡∏î‡πâ: ${canCancelIds.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`;
            if (alreadyCancelled.length > 0) {
                preCheckMsg += `\n‚ö†Ô∏è ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß/‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï: ${alreadyCancelled.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`;
                preCheckMsg += '\n' + alreadyCancelled.slice(0, 5).join('\n');
            }
            preCheckMsg += `\n\n‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡πÄ‡∏ó‡∏£‡∏î (‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÑ‡∏î‡πâ):\n${canCancelDocs.slice(0, 5).join('\n')}${canCancelDocs.length > 5 ? '\n...' : ''}`;
            preCheckMsg += `\n\n‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô: ${empName} (${empCode})\n‡πÄ‡∏ö‡∏≠‡∏£‡πå: ${empPhone}\n‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó: ${cancelTypeText}\n‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏: ${reasonCancelText}\n‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°: ${reason || '-'}`;
            preCheckMsg += `\n\n‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å ${canCancelIds.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£?`;

            if (!confirm(preCheckMsg)) {
                originalBtn.disabled = false;
                originalBtn.textContent = 'üóëÔ∏è ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å';
                return;
            }

            // === ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô 3: ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏à‡∏£‡∏¥‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ú‡πà‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö ===
            originalBtn.textContent = '‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å...';

            let successCount = 0;
            let failedCount = 0;
            const errors = [];

            for (const tradeInId of canCancelIds) {
                try {
                    const cancelPayload = {
                        param: {
                            TRADE_IN_ID: tradeInId.toString(),
                            EMP_CODE: empCode,
                            EMP_FULL_NAME: empName,
                            EMP_PHONE_NUMBER: empPhone,
                            REASON: reason || reasonCancelText,
                            CANCEL_STATUS: cancelType,
                            REASON_CANCEL: reasonCancel,
                            DESCRIPTION: reason || '-'
                        }
                    };

                    const cancelResponse = await fetch('/api/cancel-data', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ payload: cancelPayload })
                    });

                    if (cancelResponse.ok) {
                        const cancelResult = await cancelResponse.json();
                        const isSuccess = cancelResult.d?.is_success || cancelResult.d?.success;

                        if (isSuccess) {
                            successCount++;
                        } else {
                            failedCount++;
                            const msg = cancelResult.d?.message || '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à';
                            errors.push(`ID ${tradeInId}: ${Array.isArray(msg) ? msg.join(', ') : msg}`);
                        }
                    } else {
                        failedCount++;
                        errors.push(`ID ${tradeInId}: HTTP ${cancelResponse.status}`);
                    }
                } catch (error) {
                    failedCount++;
                    errors.push(`ID ${tradeInId}: ${error.message}`);
                }
            }

            // ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå
            if (successCount > 0) {
                let msg = `‚úÖ ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ${successCount} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`;
                if (failedCount > 0) {
                    msg += `\n‚ùå ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß ${failedCount} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`;
                    if (errors.length > 0) {
                        msg += '\n\n‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î:\n' + errors.slice(0, 5).join('\n');
                    }
                }
                alert(msg);
                await searchData();
            } else {
                let msg = `‚ùå ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ${failedCount} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`;
                if (errors.length > 0) {
                    msg += '\n\n‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î:\n' + errors.slice(0, 5).join('\n');
                }
                alert(msg);
            }

            originalBtn.disabled = false;
            originalBtn.textContent = 'üóëÔ∏è ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å';
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô
        document.getElementById('reportForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            await generateReport();
        });

        function resetReportForm() {
            document.getElementById('reportForm').reset();
            const today = new Date();
            const yesterday = new Date(today);
            yesterday.setDate(yesterday.getDate() - 1);
            document.getElementById('reportDateStart').valueAsDate = yesterday;
            document.getElementById('reportDateEnd').valueAsDate = today;
        }

        async function generateReport() {
            const container = document.getElementById('reportContainer');
            const submitBtn = document.querySelector('#reportForm button[type="submit"]');

            // ‡πÅ‡∏™‡∏î‡∏á loading ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Ñ‡∏≥‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏°‡∏≤‡∏Å
            const dateStart = document.getElementById('reportDateStart').value;
            const dateEnd = document.getElementById('reportDateEnd').value;
            const daysDiff = Math.ceil((new Date(dateEnd) - new Date(dateStart)) / (1000 * 60 * 60 * 24));

            let loadingMessage = '‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô...';
            if (daysDiff > 90) {
                loadingMessage = '‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô...<br><small style="color: #ff9800;">‚ö†Ô∏è ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏°‡∏≤‡∏Å ‡∏≠‡∏≤‡∏à‡πÉ‡∏ä‡πâ‡πÄ‡∏ß‡∏•‡∏≤ 30-60 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ</small>';
            } else if (daysDiff > 30) {
                loadingMessage = '‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô...<br><small style="color: #2196F3;">‚ÑπÔ∏è ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà...</small>';
            }

            container.innerHTML = `<div class="loading">${loadingMessage}</div>`;
            submitBtn.disabled = true;

            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Zone ‡∏´‡∏£‡∏∑‡∏≠‡∏™‡∏≤‡∏Ç‡∏≤‡πÄ‡∏î‡∏µ‡πà‡∏¢‡∏ß
            const zoneSelect = document.getElementById('reportZoneSelect');
            const branchSelect = document.getElementById('reportBranchSelect');
            const selectedZone = zoneSelect.value;

            let branchIds = [];
            let reportTitle = '';

            if (selectedZone) {
                // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Zone
                branchIds = ZoneHelper.getBranchIdsByZone(selectedZone);
                const zone = ZONES_DATA.find(z => z.zone_id === selectedZone);
                reportTitle = `üó∫Ô∏è ${zone.zone_name} (${branchIds.length} ‡∏™‡∏≤‡∏Ç‡∏≤)`;
                console.log(`üó∫Ô∏è ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô Zone: ${selectedZone}, ‡∏™‡∏≤‡∏Ç‡∏≤: ${branchIds.join(', ')}`);
            } else {
                // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏≤‡∏Ç‡∏≤‡πÄ‡∏î‡∏µ‡πà‡∏¢‡∏ß
                const branchId = branchSelect.value || localStorage.getItem('selected_branch_id') || '231';
                branchIds = [branchId];
                const selectedOption = branchSelect.options[branchSelect.selectedIndex];
                reportTitle = selectedOption ? selectedOption.textContent : branchId;
            }

            // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏ß‡πâ‡πÉ‡∏ä‡πâ‡πÅ‡∏™‡∏î‡∏á‡πÉ‡∏ô‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô
            window.currentReportBranch = {
                ids: branchIds,
                title: reportTitle,
                isZone: branchIds.length > 1
            };

            // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô Zone (‡∏´‡∏•‡∏≤‡∏¢‡∏™‡∏≤‡∏Ç‡∏≤) ‡πÉ‡∏´‡πâ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡∏•‡∏∞‡∏™‡∏≤‡∏Ç‡∏≤‡πÅ‡∏•‡πâ‡∏ß‡∏£‡∏ß‡∏°‡∏Å‡∏±‡∏ô (session ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡πÇ‡∏î‡∏¢ backend)
            if (branchIds.length > 1) {
                await generateMultiBranchReport(branchIds, container, submitBtn);
            } else {
                // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏≤‡∏Ç‡∏≤‡πÄ‡∏î‡∏µ‡∏¢‡∏ß (‡πÅ‡∏ö‡∏ö‡πÄ‡∏î‡∏¥‡∏°)
                await generateSingleBranchReport(branchIds[0], container, submitBtn);
            }
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏≤‡∏Ç‡∏≤‡πÄ‡∏î‡∏µ‡∏¢‡∏ß
        async function generateSingleBranchReport(branchId, container, submitBtn) {
            const params = new URLSearchParams({
                branchId: branchId,
                saleCode: document.getElementById('reportSaleCode').value,
                dateStart: formatDateThai(document.getElementById('reportDateStart').value),
                dateEnd: formatDateThai(document.getElementById('reportDateEnd').value),
                customerSign: ''
            });

            try {
                // ‡πÄ‡∏û‡∏¥‡πà‡∏° timeout ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö fetch (60 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ)
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 60000);

                const response = await fetch(`/api/report?${params}`, {
                    signal: controller.signal
                });
                clearTimeout(timeoutId);

                const data = await response.json();

                if (data.error) {
                    container.innerHTML = `
                        <div class="error">
                            <h3>‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î</h3>
                            <p>${data.error}</p>
                            ${data.message ? `<p><small>${data.message}</small></p>` : ''}
                        </div>
                    `;
                } else {
                    displayReport(data);
                }
            } catch (error) {
                let errorMessage = error.message;
                if (error.name === 'AbortError') {
                    errorMessage = '‡∏Å‡∏≤‡∏£‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ä‡πâ‡πÄ‡∏ß‡∏•‡∏≤‡∏ô‡∏≤‡∏ô‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ (Timeout) ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡∏•‡∏î‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏≤‡∏Ç‡∏≤‡πÄ‡∏î‡∏µ‡∏¢‡∏ß';
                }
                container.innerHTML = `
                    <div class="error">
                        <h3>‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î</h3>
                        <p>${errorMessage}</p>
                        <p><small>üí° ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥: ‡∏•‡∏≠‡∏á‡∏•‡∏î‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤ ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏î‡∏π‡∏ó‡∏µ‡∏•‡∏∞‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</small></p>
                    </div>
                `;
            } finally {
                submitBtn.disabled = false;
            }
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏´‡∏•‡∏≤‡∏¢‡∏™‡∏≤‡∏Ç‡∏≤ (Zone)
        async function generateMultiBranchReport(branchIds, container, submitBtn) {
            const dateStart = formatDateThai(document.getElementById('reportDateStart').value);
            const dateEnd = formatDateThai(document.getElementById('reportDateEnd').value);
            const saleCode = document.getElementById('reportSaleCode').value;

            let allDetails = [];
            let totalFetched = 0;
            let successCount = 0;
            let failCount = 0;

            // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó loading message
            container.innerHTML = `
                <div class="loading">
                    ‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Zone (${branchIds.length} ‡∏™‡∏≤‡∏Ç‡∏≤)...<br>
                    <small>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•: 0/${branchIds.length} ‡∏™‡∏≤‡∏Ç‡∏≤</small>
                </div>
            `;

            for (let i = 0; i < branchIds.length; i++) {
                const branchId = branchIds[i];

                // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
                container.innerHTML = `
                    <div class="loading">
                        ‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Zone (${branchIds.length} ‡∏™‡∏≤‡∏Ç‡∏≤)...<br>
                        <small>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•: ${i + 1}/${branchIds.length} ‡∏™‡∏≤‡∏Ç‡∏≤</small><br>
                        <small style="color: #4CAF50;">‚úÖ ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${successCount} | ‚ùå ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ${failCount}</small>
                    </div>
                `;

                try {
                    const params = new URLSearchParams({
                        branchId: branchId,
                        saleCode: saleCode,
                        dateStart: dateStart,
                        dateEnd: dateEnd,
                        customerSign: ''
                    });

                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 30000); // 30 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ‡∏ï‡πà‡∏≠‡∏™‡∏≤‡∏Ç‡∏≤

                    const response = await fetch(`/api/report?${params}`, {
                        signal: controller.signal
                    });
                    clearTimeout(timeoutId);

                    const data = await response.json();

                    if (data.details && data.details.length > 0) {
                        allDetails = allDetails.concat(data.details);
                        totalFetched += data.details.length;
                        successCount++;
                    } else {
                        failCount++;
                    }
                } catch (error) {
                    console.error(`Error fetching branch ${branchId}:`, error);
                    failCount++;
                }
            }

            // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏£‡∏ß‡∏°‡πÅ‡∏•‡πâ‡∏ß
            if (allDetails.length > 0) {
                // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏™‡∏£‡∏∏‡∏õ‡πÉ‡∏´‡∏°‡πà‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                const combinedReport = calculateCombinedReport(allDetails);
                displayReport({
                    report: combinedReport,
                    details: allDetails
                });
            } else {
                container.innerHTML = `
                    <div class="error">
                        <h3>‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h3>
                        <p>‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Zone ‡∏ô‡∏µ‡πâ</p>
                        <p><small>‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡πâ‡∏ß ${branchIds.length} ‡∏™‡∏≤‡∏Ç‡∏≤</small></p>
                    </div>
                `;
            }

            submitBtn.disabled = false;
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏£‡∏ß‡∏°‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏•‡∏≤‡∏¢‡∏™‡∏≤‡∏Ç‡∏≤
        function calculateCombinedReport(items) {
            const report = {
                totalCount: items.length,
                confirmedCount: 0,
                notConfirmedCount: 0,
                cancelledCount: 0,
                totalAmount: 0,
                confirmedAmount: 0,
                statusSummary: {},
                brandSummary: {},
                dailySummary: {},
                salesSummary: {}
            };

            items.forEach(item => {
                const status = item.BIDDING_STATUS_NAME || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
                const amount = parseFloat(item.amount) || 0;
                const isConfirmed = ['‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏£‡∏≤‡∏Ñ‡∏≤‡πÅ‡∏•‡πâ‡∏ß', '‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏£‡∏≤‡∏Ñ‡∏≤'].includes(status);

                // Status summary
                if (!report.statusSummary[status]) {
                    report.statusSummary[status] = { count: 0, amount: 0 };
                }
                report.statusSummary[status].count++;
                report.statusSummary[status].amount += amount;

                // Brand summary
                const brand = item.brand_name || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
                if (!report.brandSummary[brand]) {
                    report.brandSummary[brand] = { count: 0, amount: 0 };
                }
                report.brandSummary[brand].count++;
                report.brandSummary[brand].amount += amount;

                // Daily summary
                const date = item.document_date || '';
                if (date) {
                    if (!report.dailySummary[date]) {
                        report.dailySummary[date] = { count: 0, confirmedCount: 0, totalAmount: 0, confirmedAmount: 0 };
                    }
                    report.dailySummary[date].count++;
                    report.dailySummary[date].totalAmount += amount;
                    if (isConfirmed) {
                        report.dailySummary[date].confirmedCount++;
                        report.dailySummary[date].confirmedAmount += amount;
                    }
                }

                // Sales summary
                const saleCode = item.SALE_CODE || '';
                if (saleCode) {
                    if (!report.salesSummary[saleCode]) {
                        report.salesSummary[saleCode] = {
                            name: item.SALE_NAME || '',
                            count: 0,
                            confirmedCount: 0,
                            totalAmount: 0,
                            confirmedAmount: 0
                        };
                    }
                    report.salesSummary[saleCode].count++;
                    report.salesSummary[saleCode].totalAmount += amount;
                    if (isConfirmed) {
                        report.salesSummary[saleCode].confirmedCount++;
                        report.salesSummary[saleCode].confirmedAmount += amount;
                    }
                }

                // Totals
                report.totalAmount += amount;
                if (isConfirmed) {
                    report.confirmedCount++;
                    report.confirmedAmount += amount;
                } else {
                    report.notConfirmedCount++;
                }

                if (status === '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£') {
                    report.cancelledCount++;
                }
            });

            return report;
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏≤‡∏Ç‡∏≤‡πÄ‡∏î‡∏µ‡∏¢‡∏ß (‡πÄ‡∏î‡∏¥‡∏°)
        async function generateSingleBranchReport(branchId, container, submitBtn) {
            const params = new URLSearchParams({
                branchId: branchId,
                saleCode: document.getElementById('reportSaleCode').value,
                dateStart: formatDateThai(document.getElementById('reportDateStart').value),
                dateEnd: formatDateThai(document.getElementById('reportDateEnd').value),
                customerSign: ''
            });

            try {
                // ‡πÄ‡∏û‡∏¥‡πà‡∏° timeout ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö fetch (60 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ)
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 60000);

                const response = await fetch(`/api/report?${params}`, {
                    signal: controller.signal
                });
                clearTimeout(timeoutId);

                const data = await response.json();

                if (data.error) {
                    container.innerHTML = `
                        <div class="error">
                            <h3>‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î</h3>
                            <p>${data.error}</p>
                            ${data.message ? `<p><small>${data.message}</small></p>` : ''}
                        </div>
                    `;
                } else {
                    displayReport(data);
                }
            } catch (error) {
                let errorMessage = error.message;
                if (error.name === 'AbortError') {
                    errorMessage = '‡∏Å‡∏≤‡∏£‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ä‡πâ‡πÄ‡∏ß‡∏•‡∏≤‡∏ô‡∏≤‡∏ô‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ (Timeout) ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡∏•‡∏î‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å';
                }
                container.innerHTML = `
                    <div class="error">
                        <h3>‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î</h3>
                        <p>${error.message}</p>
                    </div>
                `;
            } finally {
                submitBtn.disabled = false;
            }
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏´‡∏•‡∏≤‡∏¢‡∏™‡∏≤‡∏Ç‡∏≤ (Zone)
        async function generateMultiBranchReport(branchIds, container, submitBtn) {
            try {
                let allDetails = [];
                let combinedReport = {
                    totalCount: 0,
                    confirmedCount: 0,
                    notConfirmedCount: 0,
                    cancelledCount: 0,
                    totalAmount: 0,
                    confirmedAmount: 0,
                    statusSummary: {},
                    brandSummary: {},
                    dailySummary: {},
                    salesSummary: {}
                };

                // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡∏•‡∏∞‡∏™‡∏≤‡∏Ç‡∏≤
                for (let i = 0; i < branchIds.length; i++) {
                    const branchId = branchIds[i];
                    container.innerHTML = `<div class="loading">‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô... (${i + 1}/${branchIds.length} ‡∏™‡∏≤‡∏Ç‡∏≤)</div>`;

                    const params = new URLSearchParams({
                        branchId: branchId,
                        saleCode: document.getElementById('reportSaleCode').value,
                        dateStart: formatDateThai(document.getElementById('reportDateStart').value),
                        dateEnd: formatDateThai(document.getElementById('reportDateEnd').value),
                        customerSign: ''
                    });

                    const response = await fetch(`/api/report?${params}`);
                    const data = await response.json();

                    if (data.error) {
                        console.error(`‚ùå ‡∏™‡∏≤‡∏Ç‡∏≤ ${branchId}: ${data.error}`);
                    } else {
                        // ‡∏£‡∏ß‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                        const report = data.report;
                        allDetails = allDetails.concat(data.details || []);

                        combinedReport.totalCount += report.totalCount || 0;
                        combinedReport.confirmedCount += report.confirmedCount || 0;
                        combinedReport.notConfirmedCount += report.notConfirmedCount || 0;
                        combinedReport.cancelledCount += report.cancelledCount || 0;
                        combinedReport.totalAmount += report.totalAmount || 0;
                        combinedReport.confirmedAmount += report.confirmedAmount || 0;

                        // ‡∏£‡∏ß‡∏° statusSummary
                        for (const [status, info] of Object.entries(report.statusSummary || {})) {
                            if (!combinedReport.statusSummary[status]) {
                                combinedReport.statusSummary[status] = { count: 0, amount: 0 };
                            }
                            combinedReport.statusSummary[status].count += info.count;
                            combinedReport.statusSummary[status].amount += info.amount;
                        }

                        // ‡∏£‡∏ß‡∏° brandSummary
                        for (const [brand, info] of Object.entries(report.brandSummary || {})) {
                            if (!combinedReport.brandSummary[brand]) {
                                combinedReport.brandSummary[brand] = { count: 0, amount: 0 };
                            }
                            combinedReport.brandSummary[brand].count += info.count;
                            combinedReport.brandSummary[brand].amount += info.amount;
                        }

                        // ‡∏£‡∏ß‡∏° dailySummary
                        for (const [date, info] of Object.entries(report.dailySummary || {})) {
                            if (!combinedReport.dailySummary[date]) {
                                combinedReport.dailySummary[date] = { count: 0, confirmedCount: 0, totalAmount: 0, confirmedAmount: 0 };
                            }
                            combinedReport.dailySummary[date].count += info.count;
                            combinedReport.dailySummary[date].confirmedCount += info.confirmedCount;
                            combinedReport.dailySummary[date].totalAmount += info.totalAmount;
                            combinedReport.dailySummary[date].confirmedAmount += info.confirmedAmount;
                        }

                        // ‡∏£‡∏ß‡∏° salesSummary
                        for (const [saleCode, info] of Object.entries(report.salesSummary || {})) {
                            if (!combinedReport.salesSummary[saleCode]) {
                                combinedReport.salesSummary[saleCode] = {
                                    name: info.name,
                                    count: 0,
                                    confirmedCount: 0,
                                    totalAmount: 0,
                                    confirmedAmount: 0
                                };
                            }
                            combinedReport.salesSummary[saleCode].count += info.count;
                            combinedReport.salesSummary[saleCode].confirmedCount += info.confirmedCount;
                            combinedReport.salesSummary[saleCode].totalAmount += info.totalAmount;
                            combinedReport.salesSummary[saleCode].confirmedAmount += info.confirmedAmount;
                        }
                    }
                }

                // ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏£‡∏ß‡∏°
                displayReport({
                    report: combinedReport,
                    details: allDetails
                });

                console.log(`‚úÖ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô ${branchIds.length} ‡∏™‡∏≤‡∏Ç‡∏≤‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô`);
            } catch (error) {
                container.innerHTML = `
                    <div class="error">
                        <h3>‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î</h3>
                        <p>${error.message}</p>
                    </div>
                `;
            } finally {
                submitBtn.disabled = false;
            }
        }

        function displayReport(data) {
            const container = document.getElementById('reportContainer');
            const reportData = data.report || {};

            // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏ß‡πâ‡πÉ‡∏ä‡πâ copy
            currentReportData = data;

            // ‡πÅ‡∏™‡∏î‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏Ç‡∏≤‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô
            const branchInfo = window.currentReportBranch || { id: '231', name: '231' };
            const branchDisplay = `<div style="background: #f8f9fa; padding: 15px; border-radius: 10px; margin-bottom: 20px; border-left: 4px solid #667eea;">
                <strong style="color: #667eea;">üè¢ ‡∏™‡∏≤‡∏Ç‡∏≤:</strong> ${branchInfo.name}
            </div>`;

            let html = `
                ${branchDisplay}
                <div style="text-align: right; margin-bottom: 15px; display: flex; gap: 10px; justify-content: flex-end;">
                    <button onclick="exportExcelReport()" style="background: #17a2b8; padding: 10px 20px;">üì• Export Excel</button>
                    <button onclick="copyReportText()" style="background: #28a745; padding: 10px 20px;">üìã Copy ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</button>
                    <button onclick="sendToTelegram()" style="background: #0088cc; padding: 10px 20px;">üì§ ‡∏™‡πà‡∏á‡πÑ‡∏õ Telegram</button>
                </div>

                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px;">
                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 25px; border-radius: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                        <div style="font-size: 14px; opacity: 0.9; margin-bottom: 5px;">üìä ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
                        <div style="font-size: 32px; font-weight: bold;">${reportData.totalCount || 0}</div>
                        <div style="font-size: 12px; opacity: 0.8; margin-top: 5px;">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</div>
                    </div>

                    <div style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); color: white; padding: 25px; border-radius: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                        <div style="font-size: 14px; opacity: 0.9; margin-bottom: 5px;">üí∞ ‡∏¢‡∏≠‡∏î‡πÄ‡∏ó‡∏£‡∏î‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
                        <div style="font-size: 28px; font-weight: bold;">${(reportData.totalAmount || 0).toLocaleString('th-TH', { minimumFractionDigits: 2 })}</div>
                        <div style="font-size: 12px; opacity: 0.8; margin-top: 5px;">‡∏ö‡∏≤‡∏ó</div>
                    </div>

                    <div style="background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); color: white; padding: 25px; border-radius: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                        <div style="font-size: 14px; opacity: 0.9; margin-bottom: 5px;">‚úÖ ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ï‡∏Å‡∏•‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏Ç‡∏≤‡∏¢</div>
                        <div style="font-size: 28px; font-weight: bold;">${(reportData.confirmedAmount || 0).toLocaleString('th-TH', { minimumFractionDigits: 2 })}</div>
                        <div style="font-size: 12px; opacity: 0.8; margin-top: 5px;">${reportData.confirmedCount || 0} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ (‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô+‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î)</div>
                    </div>

                    <div style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; padding: 25px; border-radius: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                        <div style="font-size: 14px; opacity: 0.9; margin-bottom: 5px;">‚ùå ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏ï‡∏Å‡∏•‡∏á</div>
                        <div style="font-size: 32px; font-weight: bold;">${reportData.notConfirmedCount || 0}</div>
                        <div style="font-size: 12px; opacity: 0.8; margin-top: 5px;">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ (‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏≠‡∏∑‡πà‡∏ô‡πÜ)</div>
                    </div>
                </div>

                <div style="background: white; padding: 20px; border-radius: 15px; margin-bottom: 20px;">
                    <h3 style="margin-bottom: 15px; color: #667eea;">üìÖ ‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡πÄ‡∏ó‡∏£‡∏î‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô</h3>
                    <div class="table-wrapper">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
                                    <th style="text-align: right;">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</th>
                                    <th style="text-align: right;">‡∏¢‡∏≠‡∏î‡πÄ‡∏ó‡∏£‡∏î‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡∏ö‡∏≤‡∏ó)</th>
                                    <th style="text-align: right;">‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ï‡∏Å‡∏•‡∏á (‡∏ö‡∏≤‡∏ó)</th>
                                    <th style="text-align: right;">‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏ï‡∏Å‡∏•‡∏á (%)</th>
                                </tr>
                            </thead>
                            <tbody>
            `;

            const dailySummary = reportData.dailySummary || {};
            for (const [date, info] of Object.entries(dailySummary)) {
                const confirmedCount = info.confirmedCount || 0;
                const totalCount = info.count || 0;
                const rate = totalCount > 0 ? ((confirmedCount / totalCount) * 100).toFixed(1) : 0;
                const notConfirmedCount = totalCount - confirmedCount;
                html += `
                    <tr>
                        <td><strong>${date}</strong></td>
                        <td style="text-align: right;">${totalCount} <span style="color: #999; font-size: 11px;">(‚úÖ${confirmedCount} ‚ùå${notConfirmedCount})</span></td>
                        <td style="text-align: right;">${(info.totalAmount || 0).toLocaleString('th-TH', { minimumFractionDigits: 2 })}</td>
                        <td style="text-align: right; color: #11998e; font-weight: 600;">${(info.confirmedAmount || 0).toLocaleString('th-TH', { minimumFractionDigits: 2 })}</td>
                        <td style="text-align: right;">${rate}%</td>
                    </tr>
                `;
            }

            html += `
                            </tbody>
                        </table>
                    </div>
                </div>

                <div style="background: white; padding: 20px; border-radius: 15px; margin-bottom: 20px;">
                    <h3 style="margin-bottom: 15px; color: #667eea;">üë§ ‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡πÄ‡∏ó‡∏£‡∏î‡∏ï‡∏≤‡∏°‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Ç‡∏≤‡∏¢</h3>
                    <div class="table-wrapper">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</th>
                                    <th style="text-align: right;">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</th>
                                    <th style="text-align: right;">‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏ï‡∏Å‡∏•‡∏á (%)</th>
                                </tr>
                            </thead>
                            <tbody>
            `;

            const salesSummary = reportData.salesSummary || {};
            for (const [saleCode, info] of Object.entries(salesSummary)) {
                const confirmedCount = info.confirmedCount || 0;
                const totalCount = info.count || 0;
                const rate = totalCount > 0 ? ((confirmedCount / totalCount) * 100).toFixed(1) : 0;
                const notConfirmedCount = totalCount - confirmedCount;
                html += `
                    <tr>
                        <td><strong>${saleCode}</strong></td>
                        <td style="text-align: right;">${totalCount} <span style="color: #999; font-size: 11px;">(‚úÖ${confirmedCount} ‚ùå${notConfirmedCount})</span></td>
                        <td style="text-align: right; font-weight: 600; color: ${rate >= 50 ? '#11998e' : '#f5576c'};">${rate}%</td>
                    </tr>
                `;
            }

            html += `
                            </tbody>
                        </table>
                    </div>
                </div>

                <div style="background: white; padding: 20px; border-radius: 15px; margin-bottom: 20px;">
                    <h3 style="margin-bottom: 15px; color: #667eea;">üìã ‡∏™‡∏£‡∏∏‡∏õ‡∏ï‡∏≤‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</h3>
                    <div class="table-wrapper">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                                    <th style="text-align: right;">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th>
                                    <th style="text-align: right;">‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤ (‡∏ö‡∏≤‡∏ó)</th>
                                </tr>
                            </thead>
                            <tbody>
            `;

            const statusSummary = reportData.statusSummary || {};
            for (const [status, info] of Object.entries(statusSummary)) {
                html += `
                    <tr>
                        <td>${status}</td>
                        <td style="text-align: right;">${info.count || 0}</td>
                        <td style="text-align: right;">${(info.amount || 0).toLocaleString('th-TH', { minimumFractionDigits: 2 })}</td>
                    </tr>
                `;
            }

            html += `
                            </tbody>
                        </table>
                    </div>
                </div>

                <div style="background: white; padding: 20px; border-radius: 15px;">
                    <h3 style="margin-bottom: 15px; color: #667eea;">üì± ‡∏™‡∏£‡∏∏‡∏õ‡∏ï‡∏≤‡∏°‡πÅ‡∏ö‡∏£‡∏ô‡∏î‡πå</h3>
                    <div class="table-wrapper">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>‡πÅ‡∏ö‡∏£‡∏ô‡∏î‡πå</th>
                                    <th style="text-align: right;">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th>
                                    <th style="text-align: right;">‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤ (‡∏ö‡∏≤‡∏ó)</th>
                                </tr>
                            </thead>
                            <tbody>
            `;

            const brandSummary = reportData.brandSummary || {};
            for (const [brand, info] of Object.entries(brandSummary)) {
                html += `
                    <tr>
                        <td>${brand}</td>
                        <td style="text-align: right;">${info.count || 0}</td>
                        <td style="text-align: right;">${(info.amount || 0).toLocaleString('th-TH', { minimumFractionDigits: 2 })}</td>
                    </tr>
                `;
            }

            html += `
                            </tbody>
                        </table>
                    </div>
                </div>
            `;

            container.innerHTML = html;
        }

        // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÑ‡∏ß‡πâ‡πÉ‡∏ä‡πâ copy
        let currentReportData = null;

        async function sendToTelegram() {
            if (!currentReportData) {
                alert('‚ùå ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô');
                return;
            }

            // ‡∏î‡∏∂‡∏á‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Telegram ‡∏à‡∏≤‡∏Å localStorage
            const botToken = localStorage.getItem('telegramBotToken') || '';
            const chatId = localStorage.getItem('telegramChatId') || '';

            if (!botToken || !chatId) {
                const setup = confirm('‚ùå ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Telegram Bot\n\n‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?');
                if (setup) {
                    showTelegramSetup();
                }
                return;
            }

            const report = currentReportData.report;
            const dateStart = document.getElementById('reportDateStart').value;
            const dateEnd = document.getElementById('reportDateEnd').value;

            // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô
            let message = `üìä ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏¢‡∏≠‡∏î‡πÄ‡∏ó‡∏£‡∏î\n`;
            message += `üìÖ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: ${dateStart} - ${dateEnd}\n`;
            message += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n`;
            message += `üìà ‡∏™‡∏£‡∏∏‡∏õ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°\n`;
            message += `‚Ä¢ ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: ${report.totalCount || 0} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£\n`;
            message += `‚Ä¢ ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ï‡∏Å‡∏•‡∏á: ${report.confirmedCount || 0} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£\n`;
            message += `‚Ä¢ ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏ï‡∏Å‡∏•‡∏á: ${report.notConfirmedCount || 0} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£\n\n`;
            message += `üë§ ‡∏™‡∏£‡∏∏‡∏õ‡∏ï‡∏≤‡∏°‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô\n`;

            const salesSummary = report.salesSummary || {};
            for (const [saleCode, info] of Object.entries(salesSummary)) {
                const confirmedCount = info.confirmedCount || 0;
                const totalCount = info.count || 0;
                const notConfirmedCount = totalCount - confirmedCount;
                message += `${saleCode}: ${totalCount} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ (‚úÖ${confirmedCount} ‚ùå${notConfirmedCount})\n`;
            }

            message += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ`;

            // ‡πÅ‡∏™‡∏î‡∏á loading
            const button = event.target;
            const originalText = button.innerHTML;
            button.disabled = true;
            button.innerHTML = '‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á...';

            try {
                const response = await fetch('/api/send-telegram', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        botToken: botToken,
                        chatId: chatId,
                        message: message
                    })
                });

                const result = await response.json();

                if (result.success) {
                    alert('‚úÖ ‡∏™‡πà‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÑ‡∏õ Telegram ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!');
                } else {
                    alert('‚ùå ‡∏™‡πà‡∏á‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + result.error);
                }
            } catch (error) {
                alert('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message);
            } finally {
                button.disabled = false;
                button.innerHTML = originalText;
            }
        }

        function showTelegramSetup() {
            const botToken = prompt('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà Telegram Bot Token:\n\n(‡∏î‡∏π‡∏ß‡∏¥‡∏ò‡∏µ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ô TELEGRAM-SETUP.md)', localStorage.getItem('telegramBotToken') || '');
            if (!botToken) return;

            const chatId = prompt('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà Chat ID:\n\n(‡∏î‡∏π‡∏ß‡∏¥‡∏ò‡∏µ‡∏´‡∏≤‡πÉ‡∏ô TELEGRAM-SETUP.md)', localStorage.getItem('telegramChatId') || '');
            if (!chatId) return;

            localStorage.setItem('telegramBotToken', botToken);
            localStorage.setItem('telegramChatId', chatId);

            alert('‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Telegram ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!\n\n‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡πà‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡πÅ‡∏•‡πâ‡∏ß');
        }

        function copyReportText() {
            if (!currentReportData) {
                alert('‚ùå ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô');
                return;
            }

            const report = currentReportData.report;
            const dateStart = document.getElementById('reportDateStart').value;
            const dateEnd = document.getElementById('reportDateEnd').value;

            // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô
            let text = `üìä ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏¢‡∏≠‡∏î‡πÄ‡∏ó‡∏£‡∏î\n`;
            text += `üìÖ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: ${dateStart} - ${dateEnd}\n`;
            text += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n`;

            // ‡∏™‡∏£‡∏∏‡∏õ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°
            text += `üìà ‡∏™‡∏£‡∏∏‡∏õ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°\n`;
            text += `‚Ä¢ ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: ${report.totalCount || 0} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£\n`;
            text += `‚Ä¢ ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ï‡∏Å‡∏•‡∏á: ${report.confirmedCount || 0} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£\n`;
            text += `‚Ä¢ ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏ï‡∏Å‡∏•‡∏á: ${report.notConfirmedCount || 0} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£\n\n`;

            // ‡∏™‡∏£‡∏∏‡∏õ‡∏ï‡∏≤‡∏°‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô
            text += `üë§ ‡∏™‡∏£‡∏∏‡∏õ‡∏ï‡∏≤‡∏°‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô\n`;
            const salesSummary = report.salesSummary || {};
            for (const [saleCode, info] of Object.entries(salesSummary)) {
                const confirmedCount = info.confirmedCount || 0;
                const totalCount = info.count || 0;
                const notConfirmedCount = totalCount - confirmedCount;
                text += `${saleCode}: ${totalCount} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ (‚úÖ${confirmedCount} ‚ùå${notConfirmedCount})\n`;
            }

            text += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ`;

            // Copy to clipboard
            navigator.clipboard.writeText(text).then(() => {
                alert('‚úÖ Copy ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!\n‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ô‡∏≥‡πÑ‡∏õ‡∏ß‡∏≤‡∏á‡πÉ‡∏ô LINE ‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢');
            }).catch(err => {
                // Fallback: ‡πÅ‡∏™‡∏î‡∏á‡πÉ‡∏ô modal
                const modal = document.createElement('div');
                modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 10000;';
                modal.innerHTML = `
                    <div style="background: white; padding: 30px; border-radius: 15px; max-width: 600px; max-height: 80vh; overflow-y: auto;">
                        <h3 style="margin-bottom: 15px;">üìã ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏¢‡∏≠‡∏î‡πÄ‡∏ó‡∏£‡∏î</h3>
                        <textarea readonly style="width: 100%; height: 400px; padding: 10px; font-family: monospace; font-size: 13px; border: 1px solid #ddd; border-radius: 5px;">${text}</textarea>
                        <div style="margin-top: 15px; text-align: right;">
                            <button onclick="this.closest('div').parentElement.remove()" style="background: #667eea; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">‡∏õ‡∏¥‡∏î</button>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
                modal.querySelector('textarea').select();
            });
        }
        function exportExcelReport() {
            // ‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤‡∏à‡∏≤‡∏Å‡∏ü‡∏≠‡∏£‡πå‡∏°
            const zoneSelect = document.getElementById('reportZoneSelect');
            const branchSelect = document.getElementById('reportBranchSelect');
            const saleCode = document.getElementById('reportSaleCode').value;
            const dateStart = document.getElementById('reportDateStart').value;
            const dateEnd = document.getElementById('reportDateEnd').value;

            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà
            if (!dateStart || !dateEnd) {
                alert('‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÅ‡∏•‡∏∞‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î');
                return;
            }

            // ‡∏™‡∏£‡πâ‡∏≤‡∏á URL parameters (session ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡πÇ‡∏î‡∏¢ backend)
            const params = new URLSearchParams({
                dateStart: formatDateThai(dateStart),
                dateEnd: formatDateThai(dateEnd),
                saleCode: saleCode,
                branchId: branchSelect.value || '',
                zoneId: zoneSelect.value || ''
            });

            // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Zone ‡πÉ‡∏´‡πâ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ß‡πà‡∏≤‡∏≠‡∏≤‡∏à‡πÉ‡∏ä‡πâ‡πÄ‡∏ß‡∏•‡∏≤‡∏ô‡∏≤‡∏ô
            if (zoneSelect.value) {
                if (!confirm('‚ö†Ô∏è ‡∏Å‡∏≤‡∏£ Export ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á Zone ‡∏≠‡∏≤‡∏à‡πÉ‡∏ä‡πâ‡πÄ‡∏ß‡∏•‡∏≤ 1-2 ‡∏ô‡∏≤‡∏ó‡∏µ\n\n‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≠‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) {
                    return;
                }
            }

            // ‡πÄ‡∏õ‡∏¥‡∏î URL ‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î
            window.open(`/api/export-report?${params.toString()}`, '_blank');
        }

        async function runBotUpdate() {
            const botStatus = document.getElementById('botStatus');
            const eveUser = document.getElementById('settingEveUser').value;
            const evePass = document.getElementById('settingEvePass').value;

            if (!eveUser || !evePass) {
                alert('‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å Username ‡πÅ‡∏•‡∏∞ Password ‡∏Å‡πà‡∏≠‡∏ô‡∏ó‡∏î‡∏™‡∏≠‡∏ö Bot');
                return;
            }

            // Auto Save Credentials first before running
            await saveSettings();

            if (!confirm('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ Bot ‡∏•‡∏≠‡∏á Login ‡πÅ‡∏•‡∏∞‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?\n(‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡∏≠‡∏≤‡∏à‡πÉ‡∏ä‡πâ‡πÄ‡∏ß‡∏•‡∏≤ 10-30 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ)')) {
                return;
            }

            botStatus.innerHTML = '‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥‡∏á‡∏≤‡∏ô... (Bot ‡∏Å‡∏≥‡∏•‡∏±‡∏á Login)';
            botStatus.style.color = '#ff9800';

            try {
                const response = await fetch('/api/admin/run-bot', {
                    method: 'POST'
                });
                const result = await response.json();

                if (result.success) {
                    botStatus.innerHTML = `‚úÖ ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! Updated ${result.count} branches`;
                    botStatus.style.color = 'green';
                    alert(`‚úÖ Bot Login ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!\n\n‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏°‡∏≤‡πÑ‡∏î‡πâ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ${result.count} ‡∏™‡∏≤‡∏Ç‡∏≤`);
                    // Refresh current view
                    loadBranches();
                } else {
                    botStatus.innerHTML = `‚ùå ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ${result.error}`;
                    botStatus.style.color = 'red';
                    alert(`‚ùå Bot Login ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß\n\n‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏: ${result.error}\n\n‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏ä‡πá‡∏Ñ Username/Password ‡∏´‡∏£‡∏∑‡∏≠‡∏•‡∏≠‡∏á‡∏Å‡∏î Login ‡πÄ‡∏≠‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏ß‡πà‡∏≤‡∏£‡∏´‡∏±‡∏™‡∏ñ‡∏π‡∏Å`);
                }
            } catch (error) {
                botStatus.innerHTML = `‚ùå Error: ${error.message}`;
                botStatus.style.color = 'red';
            }
        }
    </script>
</body>

</html>